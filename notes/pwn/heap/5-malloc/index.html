<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=false><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><title>Malloc &#183; hokak の sweet home</title>
<meta name=title content="Malloc &#183; hokak の sweet home"><link rel=canonical href=https://asia-hokak.github.io/notes/pwn/heap/5-malloc/><link type=text/css rel=stylesheet href=/css/main.bundle.min.48faddc4b37527001482cb057ea9e2a46db3b1fdf09fe02e52e459bf31ac71ecf511c59eedaecb5b3b42b178c0b6de4ca1781214da1725da50dd84b789512819.css integrity="sha512-SPrdxLN1JwAUgssFfqnipG2zsf3wn+AuUuRZvzGscez1EcWe7a7LWztCsXjAtt5MoXgSFNoXJdpQ3YS3iVEoGQ=="><script type=text/javascript src=/js/appearance.min.c9658ec94486565aff073b0f09a4111942679211c19430908a6707077da499e04b9bd040a9632aa673ce252f68e4470a661d46b19168671122846ad0a1e5c38c.js integrity="sha512-yWWOyUSGVlr/BzsPCaQRGUJnkhHBlDCQimcHB32kmeBLm9BAqWMqpnPOJS9o5EcKZh1GsZFoZxEihGrQoeXDjA=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.8b56b0fd46524eaecbfe33f576b8ba2cd2a122521a89f8229a95be0b635a7ac8e774eb1d8b8b93b32bbd677c3deb734aeea62917443f124d5bf5478859767380.js integrity="sha512-i1aw/UZSTq7L/jP1dri6LNKhIlIaifgimpW+C2NaesjndOsdi4uTsyu9Z3w963NK7qYpF0Q/Ek1b9UeIWXZzgA==" data-copy data-copied></script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","q0a8ugdoi9")</script><script src=/lib/zoom/zoom.min.fcbc7f7b3dcea96e3b5570cd322c5d7a12d5351c87f9889b1c31745a2cc711df58f6b70795a86d50e63813b236ade916668332c10a70a4ce26f7c0878f525fce.js integrity="sha512-/Lx/ez3OqW47VXDNMixdehLVNRyH+YibHDF0WizHEd9Y9rcHlahtUOY4E7I2rekWZoMywQpwpM4m98CHj1Jfzg=="></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://asia-hokak.github.io/notes/pwn/heap/5-malloc/"><meta property="og:site_name" content="hokak の sweet home"><meta property="og:title" content="Malloc"><meta property="og:description" content='__libc_malloc() #__libc_malloc為呼叫malloc實際執行的function victim 是作為回傳的記憶體 __libc_malloc(size_t bytes) { mstate ar_ptr; void *victim; _Static_assert(PTRDIFF_MAX <= SIZE_MAX / 2, "PTRDIFF_MAX is not more than half of SIZE_MAX"); if (!'><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="notes"><meta property="article:published_time" content="2025-02-09T00:00:00+00:00"><meta property="article:modified_time" content="2025-02-09T00:00:00+00:00"><meta property="og:see_also" content="https://asia-hokak.github.io/notes/pwn/heap/4-arena/"><meta property="og:see_also" content="https://asia-hokak.github.io/notes/pwn/heap/3-bin/"><meta property="og:see_also" content="https://asia-hokak.github.io/notes/pwn/heap/2-chunk/"><meta property="og:see_also" content="https://asia-hokak.github.io/notes/pwn/heap/1-heap/"><meta property="og:see_also" content="https://asia-hokak.github.io/notes/pwn/heap/9-fastbin-attack/"><meta property="og:see_also" content="https://asia-hokak.github.io/notes/pwn/heap/10-tcache-poision/"><meta property="og:see_also" content="https://asia-hokak.github.io/notes/pwn/heap/12-largebin_attack/"><meta name=twitter:card content="summary"><meta name=twitter:title content="Malloc"><meta name=twitter:description content='__libc_malloc() #__libc_malloc為呼叫malloc實際執行的function victim 是作為回傳的記憶體 __libc_malloc(size_t bytes) { mstate ar_ptr; void *victim; _Static_assert(PTRDIFF_MAX <= SIZE_MAX / 2, "PTRDIFF_MAX is not more than half of SIZE_MAX"); if (!'><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Notes","name":"Malloc","headline":"Malloc","abstract":"__libc_malloc() #\r__libc_malloc為呼叫malloc實際執行的function victim 是作為回傳的記憶體 __libc_malloc(size_t bytes) { mstate ar_ptr; void *victim; _Static_assert(PTRDIFF_MAX \u0026lt;= SIZE_MAX \/ 2, \u0026#34;PTRDIFF_MAX is not more than half of SIZE_MAX\u0026#34;); if (!","inLanguage":"en","url":"https:\/\/asia-hokak.github.io\/notes\/pwn\/heap\/5-malloc\/","author":{"@type":"Person","name":"hokak"},"copyrightYear":"2025","dateCreated":"2025-02-09T00:00:00\u002b00:00","datePublished":"2025-02-09T00:00:00\u002b00:00","dateModified":"2025-02-09T00:00:00\u002b00:00","mainEntityOfPage":"true","wordCount":"3483"}]</script><meta name=author content="hokak"><link href=https://github.com/asia-hokak rel=me><link href=mailto:hokak65535@gmail.com rel=me><link href=https://www.instagram.com/hokak_/ rel=me><link href=https://www.facebook.com/asiahokak/ rel=me><link href=https://steamcommunity.com/id/CreeperSH/ rel=me><script src=/lib/jquery/jquery.slim.min.03cb160e3cfdb2667a2e2c80d283bebcf63ff8bbc4b629c9ab2babf6fae1d0c07ad470edae783efa4fabda2ac01c58d60e63b98b3c336be8208460f08f4354f5.js integrity="sha512-A8sWDjz9smZ6LiyA0oO+vPY/+LvEtinJqyur9vrh0MB61HDtrng++k+r2irAHFjWDmO5izwza+gghGDwj0NU9Q=="></script><meta name=theme-color><script src=https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js></script><script src=https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js></script><script src=https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js></script><script>const firebaseConfig={apiKey:"AIzaSyDXc0kiO2x27W1Drm-E3WLhl1qO21pUUbk",authDomain:"AIzaSyDXc0kiO2x27W1Drm-E3WLhl1qO21pUUbk",projectId:"hokak-blog",storageBucket:null,messagingSenderId:"580240083167",appId:"1:580240083167:web:878c469b74773f11acc16a",measurementId:"G-H6M7TG92EV"};var app=firebase.initializeApp(firebaseConfig),db=firebase.firestore(),auth=firebase.auth()</script><link rel=stylesheet href=/css/main.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Fira+Code&family=Noto+Sans+JP&family=Noto+Sans+TC&display=swap" rel=stylesheet></head><script type=text/javascript async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>MathJax.Hub.Config({tex2jax:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$$$$$","$$$$$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0,skipTags:["script","noscript","style","textarea","pre"],TeX:{equationNumbers:{autoNumber:"AMS"},extensions:["AMSmath.js","AMSsymbols.js"]}}}),MathJax.Hub.Queue(function(){var e,t=MathJax.Hub.getAllJax();for(e=0;e<t.length;e+=1)t[e].SourceElement().parentNode.className+=" has-jax"})</script><style>code.has-jax{font:inherit;font-size:100%;background:inherit;border:inherit;color:#515151}</style><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a></div><div class=min-h-[148px]></div><div class="fixed inset-x-0 pl-[24px] pr-[24px]" style=z-index:100><div id=menu-blur class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl shadow-2xl"></div><div class="relative max-w-[64rem] ml-auto mr-auto"><div style=padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start space-x-3"><div><a href=/ class=flex><span class=sr-only>hokak の sweet home</span>
<img src=/img/sitelogo.png width=592 height=592 class="logo max-h-[5rem] max-w-[5rem] object-scale-down object-left nozoom" alt="hokak の sweet home"></a></div><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900">hokak の sweet home</a></nav><nav class="hidden md:flex items-center space-x-5 md:ml-12 h-12"><a href=/about/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>About</p></a><a href=/posts/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>Posts</p></a><a href=/writeups/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>Writeups</p></a><div><div class="cursor-pointer flex items-center nested-menu"><a class="text-base font-medium text-gray-500 hover:text-primary-600 dark:hover:text-primary-400" title>Notes
</a><span><span class="relative block icon"><svg viewBox="0 0 20 20" fill="currentcolor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75.0 011.06.02L10 11.168l3.71-3.938a.75.75.0 111.08 1.04l-4.25 4.5a.75.75.0 01-1.08.0l-4.25-4.5a.75.75.0 01.02-1.06z" clip-rule="evenodd"/></svg></span></span></div><div class="absolute menuhide"><div class="pt-2 p-5 mt-2 rounded-xl backdrop-blur shadow-2xl"><div class="flex flex-col space-y-3"><a href=/notes/web/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-sm" title>Web</p></a><a href=/notes/crypto/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-sm" title>Crypto</p></a><a href=/notes/reverse/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-sm" title>Reverse</p></a><a href=/notes/pwn/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-sm" title>Pwn</p></a><a href=/notes/misc/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-sm" title>Misc</p></a><a href=/notes/algo/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-sm" title>Algo</p></a><a href=/notes/tools/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-sm" title>Tools</p></a><a href=/notes/others/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-sm" title>Others</p></a></div></div></div></div><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></nav><div class="flex md:hidden items-center space-x-5 md:ml-12 h-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></div></div><div class="-my-2 -mr-2 md:hidden"><label id=menu-button for=menu-controller class=block><input type=checkbox id=menu-controller class=hidden><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper style=padding-top:5px class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=/about/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>About</p></a></li><li class=mt-1><a href=/posts/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>Posts</p></a></li><li class=mt-1><a href=/writeups/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>Writeups</p></a></li><li class=mt-1><a class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>Notes</p><span><span class="relative block icon"><svg viewBox="0 0 20 20" fill="currentcolor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75.0 011.06.02L10 11.168l3.71-3.938a.75.75.0 111.08 1.04l-4.25 4.5a.75.75.0 01-1.08.0l-4.25-4.5a.75.75.0 01.02-1.06z" clip-rule="evenodd"/></svg></span></span></a></li><li class=mt-1><a href=/notes/web/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-small" title>Web</p></a></li><li class=mt-1><a href=/notes/crypto/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-small" title>Crypto</p></a></li><li class=mt-1><a href=/notes/reverse/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-small" title>Reverse</p></a></li><li class=mt-1><a href=/notes/pwn/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-small" title>Pwn</p></a></li><li class=mt-1><a href=/notes/misc/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-small" title>Misc</p></a></li><li class=mt-1><a href=/notes/algo/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-small" title>Algo</p></a></li><li class=mt-1><a href=/notes/tools/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-small" title>Tools</p></a></li><li class=mt-1><a href=/notes/others/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-sm font-small" title>Others</p></a></li><li class=mb-2></li></ul></div></label></div></div><script>(function(){var e=$(".main-menu"),t=window.location.pathname;e.find('a[href="'+t+'"]').each(function(e,t){$(t).children("p").addClass("active")})})()</script></div></div><script>window.addEventListener("scroll",function(){var t=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,n=document.getElementById("menu-blur");n.style.opacity=t/300})</script><div class="relative flex flex-col grow"><main id=main-content class=grow><article><div id=hero class="h-[150px] md:h-[200px]"></div><div id=background-container class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom" style="background-image:url(' /img/article.png ')"><div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal"></div><div class="absolute inset-0 opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral-100 dark:to-neutral-800 mix-blend-normal"></div></div><div id=background-blur class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl"></div><script>window.addEventListener("scroll",function(){var t=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,n=document.getElementById("background-blur");n.style.opacity=t/300})</script><style>.chroma{color:#c6d0f5;background-color:#303446}.chroma .cl{color:#c6d0f5}.chroma .err{color:#e78284}.chroma .x{color:#c6d0f5}.chroma .lntd{border:0;margin:0;padding:0;vertical-align:top}.chroma .lntable{width:auto;border:0;margin:0;display:block;padding:0;overflow:auto;border-spacing:0}.chroma .hl{width:100%;display:block;background-color:#51576d}.chroma .lnt{color:#838ba7;padding:0 .4em;font-size:.875rem;margin-right:.4em}.chroma .ln{color:#838ba7;padding:0 .4em;margin-right:.4em}.chroma .k{color:#ca9ee6}.chroma .kr{color:#ca9ee6}.chroma .kp{color:#ca9ee6}.chroma .kc{color:#ef9f76}.chroma .kd{color:#e78284}.chroma .kn{color:#81c8be}.chroma .kt{color:#e78284}.chroma .n{color:#c6d0f5}.chroma .nc{color:#e5c890}.chroma .no{color:#e5c890}.chroma .nd{color:#8caaee;font-weight:700}.chroma .ni{color:#81c8be}.chroma .ne{color:#ef9f76}.chroma .nf{color:#8caaee}.chroma .fm{color:#8caaee}.chroma .nl{color:#99d1db}.chroma .nn{color:#ef9f76}.chroma .py{color:#ef9f76}.chroma .nt{color:#ca9ee6}.chroma .nv{color:#f2d5cf}.chroma .vc{color:#f2d5cf}.chroma .vg{color:#f2d5cf}.chroma .vi{color:#f2d5cf}.chroma .vm{color:#f2d5cf}.chroma .na{color:#8caaee}.chroma .nb{color:#99d1db}.chroma .bp{color:#99d1db}.chroma .nx{color:#c6d0f5}.chroma .l{color:#c6d0f5}.chroma .ld{color:#c6d0f5}.chroma .s{color:#a6d189}.chroma .sc{color:#a6d189}.chroma .s1{color:#a6d189}.chroma .s2{color:#a6d189}.chroma .sb{color:#a6d189}.chroma .sx{color:#a6d189}.chroma .ss{color:#a6d189}.chroma .si{color:#a6d189}.chroma .sa{color:#e78284}.chroma .dl{color:#8caaee}.chroma .se{color:#8caaee}.chroma .sr{color:#81c8be}.chroma .sd{color:#737994}.chroma .sh{color:#737994}.chroma .m{color:#ef9f76}.chroma .mb{color:#ef9f76}.chroma .mh{color:#ef9f76}.chroma .mi{color:#ef9f76}.chroma .mf{color:#ef9f76}.chroma .il{color:#ef9f76}.chroma .mo{color:#ef9f76}.chroma .o{color:#99d1db;font-weight:700}.chroma .ow{color:#99d1db;font-weight:700}.chroma .c{color:#737994;font-style:italic}.chroma .c1{color:#737994;font-style:italic}.chroma .cm{color:#737994;font-style:italic}.chroma .cs{color:#737994;font-style:italic}.chroma .ch{color:#626880;font-style:italic}.chroma .cp{color:#737994;font-style:italic}.chroma .cpf{color:#737994;font-weight:700}.chroma .g{color:#c6d0f5}.chroma .gi{color:#a6d189;background-color:#414559}.chroma .gd{color:#e78284;background-color:#414559}.chroma .ge{color:#c6d0f5;font-style:italic}.chroma .gs{color:#c6d0f5;font-weight:700}.chroma .gl{color:#c6d0f5;text-decoration:underline}.chroma .gh{color:#ef9f76;font-weight:700}.chroma .gu{color:#ef9f76;font-weight:700}.chroma .go{color:#c6d0f5}.chroma .gp{color:#c6d0f5}.chroma .gr{color:#e78284}.chroma .gt{color:#e78284}</style><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Malloc</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2025-02-09 00:00:00 +0000 UTC">2025-02-09</time><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">17 mins</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=views_notes/pwn/heap/5-malloc/index.md class="animate-pulse inline-block text-transparent max-h-3 rounded-full mt-[-2px] align-middle bg-neutral-300 dark:bg-neutral-400" title=views>loading</span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentcolor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg>
</span></span></span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=likes_notes/pwn/heap/5-malloc/index.md class="animate-pulse inline-block text-transparent max-h-3 rounded-full mt-[-2px] align-middle bg-neutral-300 dark:bg-neutral-400" title=likes>loading</span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M47.6 300.4 228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6.0 115.2.0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg>
</span></span></span><span class="px-2 text-primary-500">&#183;</span><span>
<button id=button_likes class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400" onclick=process_article()>
<span id=button_likes_heart style=display:none class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M47.6 300.4 228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6.0 115.2.0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg>
</span></span><span id=button_likes_emtpty_heart class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M244 84l11.1 12 12-11.98C300.6 51.37 347 36.51 392.6 44.1 461.5 55.58 512 115.2 512 185.1V190.9c0 41.5-17.2 81.2-47.6 109.5L283.7 469.1c-7.5 7-17.4 10.9-27.7 10.9S235.8 476.1 228.3 469.1L47.59 300.4C17.23 272.1.0 232.4.0 190.9V185.1c0-69.9 50.52-129.52 119.4-141 44.7-7.59 92 7.27 124.6 39.9C243.1 84 244 84.01 244 84zm11.1 79.9-45-46.8c-21.7-20.82-52.5-30.7-82.8-25.66C81.55 99.07 48 138.7 48 185.1V190.9c0 28.2 11.71 55.2 32.34 74.4L256 429.3l175.7-164c20.6-19.2 32.3-46.2 32.3-74.4V185.1c0-46.4-33.6-86.03-79.3-93.66C354.4 86.4 323.6 96.28 301.9 117.1l-46.8 46.8z"/></svg>
</span></span><span id=button_likes_text>&nbsp;Like</span>
</button>
</span><span class="px-2 text-primary-500">&#183;</span>
<script type=text/javascript src=/js/zen-mode.min.63c8a202661f4a2063fdc2706685d668e8ea3da613da2224e9da527e5876e4f53dcac39ab60732626fb4151feae5d430d0cf44731e5d3c726522fcc1519c1547.js integrity="sha512-Y8iiAmYfSiBj/cJwZoXWaOjqPaYT2iIk6dpSflh25PU9ysOatgcyYm+0FR/q5dQw0M9Ecx5dPHJlIvzBUZwVRw=="></script><span class=mb-[2px]><span id=zen-mode-button class="text-lg hover:text-primary-500" title="Enable zen mode" data-title-i18n-disable="Enable zen mode" data-title-i18n-enable="Disable zen mode"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 50 50" width="50" height="50"><path fill="currentcolor" d="M12.980469 4C9.1204688 4 5.9804688 7.14 5.9804688 11L6 26H9.9804688V11c0-1.65 1.3400002-3 3.0000002-3H40.019531c1.66.0 3 1.35 3 3V39c0 1.65-1.34 3-3 3H29c0 1.54-.579062 2.94-1.539062 4H40.019531c3.86.0 7-3.14 7-7V11c0-3.86-3.14-7-7-7H12.980469zM7 28c-2.206.0-4 1.794-4 4V42c0 2.206 1.794 4 4 4H23c2.206.0 4-1.794 4-4V32c0-2.206-1.794-4-4-4H7zm0 4H23L23.001953 42H7V32z"/></svg></span></span></span></span></div><div class="flex flex-row flex-wrap items-center"></div><div class="flex flex-row flex-wrap items-center"></div></div><div class="flex author"><img class="!mt-0 !mb-0 h-24 w-24 rounded-2xl ltr:mr-4 rtl:ml-4" width=96 height=96 alt=hokak src=/img/author_hu6047748240582865998.gif><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Author</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">hokak</div><div class="text-sm text-neutral-700 dark:text-neutral-400">need more sleep</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/asia-hokak target=_blank aria-label=Github rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=mailto:hokak65535@gmail.com target=_blank aria-label=Email rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://www.instagram.com/hokak_/ target=_blank aria-label=Instagram rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M224.1 141c-63.6.0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1.0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9.0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9.0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9.0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9.0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8.0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://www.facebook.com/asiahokak/ target=_blank aria-label=Facebook rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14.0 55.52 4.84 55.52 4.84v61h-31.28c-30.8.0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://steamcommunity.com/id/CreeperSH/ target=_blank aria-label=Steam rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentcolor" d="M496 256c0 137-111.2 248-248.4 248-113.8.0-209.6-76.3-239-180.4l95.2 39.3c6.4 32.1 34.9 56.4 68.9 56.4 39.2.0 71.9-32.4 70.2-73.5l84.5-60.2c52.1 1.3 95.8-40.9 95.8-93.5.0-51.6-42-93.5-93.7-93.5s-93.7 42-93.7 93.5v1.2L176.6 279c-15.5-.9-30.7 3.4-43.5 12.1L0 236.1C10.2 108.4 117.1 8 247.6 8 384.8 8 496 119 496 256zM155.7 384.3l-30.5-12.6a52.79 52.79.0 0027.2 25.8c26.9 11.2 57.8-1.6 69-28.4 5.4-13 5.5-27.3.1-40.3S206 305.6 193 300.2c-12.9-5.4-26.7-5.2-38.9-.6l31.5 13c19.8 8.2 29.2 30.9 20.9 50.7-8.3 19.9-31 29.2-50.8 21zm173.8-129.9c-34.4.0-62.4-28-62.4-62.3s28-62.3 62.4-62.3 62.4 28 62.4 62.3-27.9 62.3-62.4 62.3zm.1-15.6c25.9.0 46.9-21 46.9-46.8.0-25.9-21-46.8-46.9-46.8s-46.9 21-46.9 46.8c.1 25.8 21.1 46.8 46.9 46.8z"/></svg></span></span></a></div></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8"><div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-[140px]"><details open id=TOCView class="toc-right mt-0 overflow-y-scroll overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="min-w-[220px] py-2 border-dotted ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#__libc_malloc>__libc_malloc()</a><ul><li><a href=#嘗試從tcache分配記憶體>嘗試從tcache分配記憶體</a></li><li><a href=#在單執行緒的情況下>在單執行緒的情況下</a></li><li><a href=#在多執行緒的情況下>在多執行緒的情況下</a></li></ul></li><li><a href=#_int_malloc>_int_malloc()</a><ul><li><a href=#fastbin>fastbin</a><ul><li><a href=#tcache>tcache</a></li><li><a href=#回傳記憶體>回傳記憶體</a></li></ul></li><li><a href=#smallbin>smallbin</a><ul><li><a href=#tcache-1>tcache</a></li><li><a href=#回傳記憶體-1>回傳記憶體</a></li><li><a href=#合併fastbin>合併fastbin</a></li></ul></li><li><a href=#unsortedbin>unsortedbin</a><ul><li><a href=#檢查>檢查</a></li><li><a href=#使用last-remainder>使用last remainder</a></li><li><a href=#unlink>unlink</a></li><li><a href=#如果fit-size>如果fit size</a></li><li><a href=#放回smallbin的情況>放回smallbin的情況</a></li><li><a href=#放回largebin的情況>放回largebin的情況</a></li><li><a href=#放回bin中剛剛那兩段只是為了找到bck和fwd>放回bin中(剛剛那兩段只是為了找到bck和fwd)</a></li><li><a href=#結束while迴圈>結束while迴圈</a></li></ul></li><li><a href=#largebin>largebin</a><ul><li><a href=#切割後的size不足成為一個chunk>切割後的size不足成為一個chunk</a></li><li><a href=#切割chunk>切割chunk</a></li><li><a href=#回傳記憶體-2>回傳記憶體</a></li></ul></li><li><a href=#search-for-larger-bin>search for larger bin</a><ul><li><a href=#找到合適的bin>找到合適的bin</a></li><li><a href=#找到>找到</a></li><li><a href=#切割後的size不足成為一個chunk-1>切割後的size不足成為一個chunk</a></li><li><a href=#回傳記憶體-3>回傳記憶體</a></li></ul></li><li><a href=#use-top>use top</a><ul><li><a href=#如果top-chunk有足夠的大小可以被切割>如果top chunk有足夠的大小可以被切割</a></li><li><a href=#如果沒有檢查是否有fastbin>如果沒有，檢查是否有fastbin</a></li><li><a href=#最終情況會用sysmalloc再要一塊記憶體>最終情況，會用sysmalloc再要一塊記憶體</a></li></ul></li></ul></li><li><a href=#__libc_realloc>__libc_realloc</a></li><li><a href=#_int_realloc>_int_realloc()</a><ul><li><a href=#如果舊的夠大>如果舊的夠大</a></li><li><a href=#嘗試向top-chunk擴展>嘗試向top chunk擴展</a></li><li><a href=#向下方free-chunk擴展>向下方free chunk擴展</a></li><li><a href=#否則重新分配記憶體>否則重新分配記憶體</a></li></ul></li><li><a href=#__libc_calloc>__libc_calloc()</a><ul><li><a href=#清空mem>清空mem</a></li></ul></li><li><a href=#references>References</a></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#__libc_malloc>__libc_malloc()</a><ul><li><a href=#嘗試從tcache分配記憶體>嘗試從tcache分配記憶體</a></li><li><a href=#在單執行緒的情況下>在單執行緒的情況下</a></li><li><a href=#在多執行緒的情況下>在多執行緒的情況下</a></li></ul></li><li><a href=#_int_malloc>_int_malloc()</a><ul><li><a href=#fastbin>fastbin</a><ul><li><a href=#tcache>tcache</a></li><li><a href=#回傳記憶體>回傳記憶體</a></li></ul></li><li><a href=#smallbin>smallbin</a><ul><li><a href=#tcache-1>tcache</a></li><li><a href=#回傳記憶體-1>回傳記憶體</a></li><li><a href=#合併fastbin>合併fastbin</a></li></ul></li><li><a href=#unsortedbin>unsortedbin</a><ul><li><a href=#檢查>檢查</a></li><li><a href=#使用last-remainder>使用last remainder</a></li><li><a href=#unlink>unlink</a></li><li><a href=#如果fit-size>如果fit size</a></li><li><a href=#放回smallbin的情況>放回smallbin的情況</a></li><li><a href=#放回largebin的情況>放回largebin的情況</a></li><li><a href=#放回bin中剛剛那兩段只是為了找到bck和fwd>放回bin中(剛剛那兩段只是為了找到bck和fwd)</a></li><li><a href=#結束while迴圈>結束while迴圈</a></li></ul></li><li><a href=#largebin>largebin</a><ul><li><a href=#切割後的size不足成為一個chunk>切割後的size不足成為一個chunk</a></li><li><a href=#切割chunk>切割chunk</a></li><li><a href=#回傳記憶體-2>回傳記憶體</a></li></ul></li><li><a href=#search-for-larger-bin>search for larger bin</a><ul><li><a href=#找到合適的bin>找到合適的bin</a></li><li><a href=#找到>找到</a></li><li><a href=#切割後的size不足成為一個chunk-1>切割後的size不足成為一個chunk</a></li><li><a href=#回傳記憶體-3>回傳記憶體</a></li></ul></li><li><a href=#use-top>use top</a><ul><li><a href=#如果top-chunk有足夠的大小可以被切割>如果top chunk有足夠的大小可以被切割</a></li><li><a href=#如果沒有檢查是否有fastbin>如果沒有，檢查是否有fastbin</a></li><li><a href=#最終情況會用sysmalloc再要一塊記憶體>最終情況，會用sysmalloc再要一塊記憶體</a></li></ul></li></ul></li><li><a href=#__libc_realloc>__libc_realloc</a></li><li><a href=#_int_realloc>_int_realloc()</a><ul><li><a href=#如果舊的夠大>如果舊的夠大</a></li><li><a href=#嘗試向top-chunk擴展>嘗試向top chunk擴展</a></li><li><a href=#向下方free-chunk擴展>向下方free chunk擴展</a></li><li><a href=#否則重新分配記憶體>否則重新分配記憶體</a></li></ul></li><li><a href=#__libc_calloc>__libc_calloc()</a><ul><li><a href=#清空mem>清空mem</a></li></ul></li><li><a href=#references>References</a></li></ul></nav></div></details><script>var margin=200,marginError=50;(function(){var t=$(window),e=$("#TOCView"),s=e.height();function n(){var n=t.height()-margin;s>=n?(e.css("overflow-y","scroll"),e.css("max-height",n+marginError+"px")):(e.css("overflow-y","hidden"),e.css("max-height","9999999px"))}t.on("resize",n),$(document).ready(n)})(),function(){var t,e=$("#TableOfContents");if(e.length>0){t=$(window);function n(){var s,o=t.scrollTop(),i=$(".anchor"),n="";if(i.each(function(e,t){t=$(t),t.offset().top-$(window).height()/3<=o&&(n=decodeURIComponent(t.attr("id")))}),s=e.find("a.active"),s.length==1&&s.eq(0).attr("href")=="#"+n)return!0;s.each(function(e,t){$(t).removeClass("active")}),e.find('a[href="#'+n+'"]').addClass("active"),e.find('a[href="#'+n+'"]').parentsUntil("#TableOfContents").each(function(e,t){$(t).children("a").parents("ul").show()})}t.on("scroll",n),$(document).ready(function(){n()})}}()</script></div></div><div class="min-w-0 min-h-0 max-w-fit"><details style=margin-left:0 class="mt-2 mb-5 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5" open><summary class="py-1 text-lg font-semibold cursor-pointer bg-primary-200 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-primary-800 dark:text-neutral-100">Heap Exploitation - This article is part of a series.</summary><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=https://asia-hokak.github.io/notes/pwn/heap/1-heap/>Part 1: Heap</a></div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=https://asia-hokak.github.io/notes/pwn/heap/2-chunk/>Part 2: Chunk</a></div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=https://asia-hokak.github.io/notes/pwn/heap/3-bin/>Part 3: Bin</a></div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=https://asia-hokak.github.io/notes/pwn/heap/4-arena/>Part 4: Arena</a></div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">Part 5: This Article</div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=https://asia-hokak.github.io/notes/pwn/heap/6-free/>Part 6: Free</a></div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=https://asia-hokak.github.io/notes/pwn/heap/9-fastbin-attack/>Part 9: Fastbin Attack</a></div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=https://asia-hokak.github.io/notes/pwn/heap/10-tcache-poision/>Part 10: Tcache Poision</a></div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=https://asia-hokak.github.io/notes/pwn/heap/11-unsorted-bin-attack/>Part 11: Unsorted Bin Attack</a></div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=https://asia-hokak.github.io/notes/pwn/heap/12-largebin_attack/>Part 12: Largebin Attack</a></div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=https://asia-hokak.github.io/notes/pwn/heap/13-unsafe-unlink/>Part 13: Unsafe Unlink</a></div></details><div class="article-content max-w-prose mb-20"><h2 class="relative group">__libc_malloc()<div id=__libc_malloc class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#__libc_malloc aria-label=Anchor>#</a></span></h2><ul><li><code>__libc_malloc</code>為呼叫<code>malloc</code>實際執行的function</li><li><code>victim</code> 是作為回傳的記憶體</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=nf>__libc_malloc</span><span class=p>(</span><span class=kt>size_t</span> <span class=n>bytes</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>mstate</span> <span class=n>ar_ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=o>*</span><span class=n>victim</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>_Static_assert</span><span class=p>(</span><span class=n>PTRDIFF_MAX</span> <span class=o>&lt;=</span> <span class=n>SIZE_MAX</span> <span class=o>/</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                   <span class=s>&#34;PTRDIFF_MAX is not more than half of SIZE_MAX&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>__malloc_initialized</span><span class=p>)</span> <span class=c1>// 檢查heap是否被初始化
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>ptmalloc_init</span><span class=p>();</span> <span class=c1>// 執行malloc 初始化
</span></span></span></code></pre></div><h3 class="relative group">嘗試從tcache分配記憶體<div id=%E5%98%97%E8%A9%A6%E5%BE%9Etcache%E5%88%86%E9%85%8D%E8%A8%98%E6%86%B6%E9%AB%94 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%98%97%E8%A9%A6%E5%BE%9Etcache%E5%88%86%E9%85%8D%E8%A8%98%E6%86%B6%E9%AB%94 aria-label=Anchor>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#if USE_TCACHE
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=cm>/* int_free also calls request2size, be careful to not pad twice.  */</span>
</span></span><span class=line><span class=cl>    <span class=kt>size_t</span> <span class=n>tbytes</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>checked_request2size</span><span class=p>(</span><span class=n>bytes</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>tbytes</span><span class=p>))</span> <span class=c1>// 確保分配大小正常
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>__set_errno</span><span class=p>(</span><span class=n>ENOMEM</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kt>size_t</span> <span class=n>tc_idx</span> <span class=o>=</span> <span class=nf>csize2tidx</span><span class=p>(</span><span class=n>tbytes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>MAYBE_INIT_TCACHE</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>DIAG_PUSH_NEEDS_COMMENT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>tc_idx</span> <span class=o>&lt;</span> <span class=n>mp_</span><span class=p>.</span><span class=n>tcache_bins</span> <span class=o>&amp;&amp;</span> <span class=n>tcache</span> <span class=o>&amp;&amp;</span> <span class=n>tcache</span><span class=o>-&gt;</span><span class=n>counts</span><span class=p>[</span><span class=n>tc_idx</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=c1>// 如果tcache有東西
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>victim</span> <span class=o>=</span> <span class=nf>tcache_get</span><span class=p>(</span><span class=n>tc_idx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nf>tag_new_usable</span><span class=p>(</span><span class=n>victim</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>DIAG_POP_NEEDS_COMMENT</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span></code></pre></div><h3 class="relative group">在單執行緒的情況下<div id=%E5%9C%A8%E5%96%AE%E5%9F%B7%E8%A1%8C%E7%B7%92%E7%9A%84%E6%83%85%E6%B3%81%E4%B8%8B class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%9C%A8%E5%96%AE%E5%9F%B7%E8%A1%8C%E7%B7%92%E7%9A%84%E6%83%85%E6%B3%81%E4%B8%8B aria-label=Anchor>#</a></span></h3><ul><li>呼叫了<code>_int_malloc()</code>，也是主要在實作malloc的函數</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>SINGLE_THREAD_P</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>victim</span> <span class=o>=</span> <span class=nf>tag_new_usable</span><span class=p>(</span><span class=nf>_int_malloc</span><span class=p>(</span><span class=o>&amp;</span><span class=n>main_arena</span><span class=p>,</span> <span class=n>bytes</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=nf>assert</span><span class=p>(</span><span class=o>!</span><span class=n>victim</span> <span class=o>||</span> <span class=nf>chunk_is_mmapped</span><span class=p>(</span><span class=nf>mem2chunk</span><span class=p>(</span><span class=n>victim</span><span class=p>))</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>               <span class=o>&amp;</span><span class=n>main_arena</span> <span class=o>==</span> <span class=nf>arena_for_chunk</span><span class=p>(</span><span class=nf>mem2chunk</span><span class=p>(</span><span class=n>victim</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>victim</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></div><h3 class="relative group">在多執行緒的情況下<div id=%E5%9C%A8%E5%A4%9A%E5%9F%B7%E8%A1%8C%E7%B7%92%E7%9A%84%E6%83%85%E6%B3%81%E4%B8%8B class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%9C%A8%E5%A4%9A%E5%9F%B7%E8%A1%8C%E7%B7%92%E7%9A%84%E6%83%85%E6%B3%81%E4%B8%8B aria-label=Anchor>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>    <span class=nf>arena_get</span><span class=p>(</span><span class=n>ar_ptr</span><span class=p>,</span> <span class=n>bytes</span><span class=p>);</span> <span class=c1>// 獲取arena
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=n>victim</span> <span class=o>=</span> <span class=nf>_int_malloc</span><span class=p>(</span><span class=n>ar_ptr</span><span class=p>,</span> <span class=n>bytes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=cm>/* Retry with another arena only if we were able to find a usable arena
</span></span></span><span class=line><span class=cl><span class=cm>       before.  */</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>victim</span> <span class=o>&amp;&amp;</span> <span class=n>ar_ptr</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span> <span class=c1>// 如果分配失敗
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>LIBC_PROBE</span><span class=p>(</span><span class=n>memory_malloc_retry</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>bytes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>ar_ptr</span> <span class=o>=</span> <span class=nf>arena_get_retry</span><span class=p>(</span><span class=n>ar_ptr</span><span class=p>,</span> <span class=n>bytes</span><span class=p>);</span> <span class=c1>// 使用其他arena
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>victim</span> <span class=o>=</span> <span class=nf>_int_malloc</span><span class=p>(</span><span class=n>ar_ptr</span><span class=p>,</span> <span class=n>bytes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>ar_ptr</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>__libc_lock_unlock</span><span class=p>(</span><span class=n>ar_ptr</span><span class=o>-&gt;</span><span class=n>mutex</span><span class=p>);</span> <span class=c1>// 在多thread的情況下會上鎖arena，這裡解鎖表示arena使用結束
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=n>victim</span> <span class=o>=</span> <span class=nf>tag_new_usable</span><span class=p>(</span><span class=n>victim</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>assert</span><span class=p>(</span><span class=o>!</span><span class=n>victim</span> <span class=o>||</span> <span class=nf>chunk_is_mmapped</span><span class=p>(</span><span class=nf>mem2chunk</span><span class=p>(</span><span class=n>victim</span><span class=p>))</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>           <span class=n>ar_ptr</span> <span class=o>==</span> <span class=nf>arena_for_chunk</span><span class=p>(</span><span class=nf>mem2chunk</span><span class=p>(</span><span class=n>victim</span><span class=p>)));</span> <span class=c1>// 檢查 victim不為空 | victim是透過mmap分配 | victim是來自正確的arena，
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=n>victim</span><span class=p>;</span>
</span></span></code></pre></div><h2 class="relative group">_int_malloc()<div id=_int_malloc class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#_int_malloc aria-label=Anchor>#</a></span></h2><p>變數功能註解都有寫了，真好owob</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=nf>_int_malloc</span> <span class=p>(</span><span class=n>mstate</span> <span class=n>av</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>bytes</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>INTERNAL_SIZE_T</span> <span class=n>nb</span><span class=p>;</span>               <span class=cm>/* normalized request size */</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>idx</span><span class=p>;</span>                 <span class=cm>/* associated bin index */</span>
</span></span><span class=line><span class=cl>    <span class=n>mbinptr</span> <span class=n>bin</span><span class=p>;</span>                      <span class=cm>/* associated bin */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>mchunkptr</span> <span class=n>victim</span><span class=p>;</span>                 <span class=cm>/* inspected/selected chunk */</span>
</span></span><span class=line><span class=cl>    <span class=n>INTERNAL_SIZE_T</span> <span class=n>size</span><span class=p>;</span>             <span class=cm>/* its size */</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>victim_index</span><span class=p>;</span>                 <span class=cm>/* its bin index */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>mchunkptr</span> <span class=n>remainder</span><span class=p>;</span>              <span class=cm>/* remainder from a split */</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>remainder_size</span><span class=p>;</span>     <span class=cm>/* its size */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>block</span><span class=p>;</span>               <span class=cm>/* bit map traverser */</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>bit</span><span class=p>;</span>                 <span class=cm>/* bit map traverser */</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>map</span><span class=p>;</span>                 <span class=cm>/* current word of binmap */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>mchunkptr</span> <span class=n>fwd</span><span class=p>;</span>                    <span class=cm>/* misc temp for linking */</span>
</span></span><span class=line><span class=cl>    <span class=n>mchunkptr</span> <span class=n>bck</span><span class=p>;</span>                    <span class=cm>/* misc temp for linking */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#if USE_TCACHE
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=kt>size_t</span> <span class=n>tcache_unsorted_count</span><span class=p>;</span>	  <span class=cm>/* count of unsorted chunks processed */</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span></code></pre></div><h3 class="relative group">fastbin<div id=fastbin class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#fastbin aria-label=Anchor>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>if</span> <span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>nb</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=nf>get_max_fast</span><span class=p>()))</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 得到對應fastbin索引
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>idx</span> <span class=o>=</span> <span class=nf>fastbin_index</span><span class=p>(</span><span class=n>nb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 得到對應索引fastbin的pointer
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mfastbinptr</span> <span class=o>*</span><span class=n>fb</span> <span class=o>=</span> <span class=o>&amp;</span><span class=nf>fastbin</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>idx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>mchunkptr</span> <span class=n>pp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>victim</span> <span class=o>=</span> <span class=o>*</span><span class=n>fb</span><span class=p>;</span> <span class=c1>// victim 是malloc_chunk的結構
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 如果對應index的fastbin存在
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>victim</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// fastbin top address對齊檢查
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_unlikely</span><span class=p>(</span><span class=nf>misaligned_chunk</span><span class=p>(</span><span class=n>victim</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>            <span class=nf>malloc_printerr</span><span class=p>(</span><span class=s>&#34;malloc(): unaligned fastbin chunk detected 2&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// unlink
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=n>SINGLE_THREAD_P</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=o>*</span><span class=n>fb</span> <span class=o>=</span> <span class=nf>REVEAL_PTR</span><span class=p>(</span><span class=n>victim</span><span class=o>-&gt;</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>            <span class=nf>REMOVE_FB</span><span class=p>(</span><span class=n>fb</span><span class=p>,</span> <span class=n>pp</span><span class=p>,</span> <span class=n>victim</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_likely</span><span class=p>(</span><span class=n>victim</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>size_t</span> <span class=n>victim_idx</span> <span class=o>=</span> <span class=nf>fastbin_index</span><span class=p>(</span><span class=nf>chunksize</span><span class=p>(</span><span class=n>victim</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nf>__builtin_expect</span><span class=p>(</span><span class=n>victim_idx</span> <span class=o>!=</span> <span class=n>idx</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=nf>malloc_printerr</span><span class=p>(</span><span class=s>&#34;malloc(): memory corruption (fast)&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nf>check_remalloced_chunk</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>victim</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span>
</span></span></code></pre></div><h4 class="relative group">tcache<div id=tcache class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#tcache aria-label=Anchor>#</a></span></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#if USE_TCACHE
</span></span></span><span class=line><span class=cl><span class=cp></span>            <span class=cm>/* While we&#39;re here, if we see other chunks of the same size,
</span></span></span><span class=line><span class=cl><span class=cm>            stash them in the tcache.  */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// 計算tcache index
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kt>size_t</span> <span class=n>tc_idx</span> <span class=o>=</span> <span class=nf>csize2tidx</span><span class=p>(</span><span class=n>nb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 如果tcache滿足要求
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=p>(</span><span class=n>tcache</span> <span class=o>&amp;&amp;</span> <span class=n>tc_idx</span> <span class=o>&lt;</span> <span class=n>mp_</span><span class=p>.</span><span class=n>tcache_bins</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>mchunkptr</span> <span class=n>tc_victim</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=cm>/* While bin not empty and tcache not full, copy chunks.  */</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 如果fastbin有東西然後tcache沒滿，把chunks裝到tcache
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>while</span> <span class=p>(</span><span class=n>tcache</span><span class=o>-&gt;</span><span class=n>counts</span><span class=p>[</span><span class=n>tc_idx</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>mp_</span><span class=p>.</span><span class=n>tcache_count</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>tc_victim</span> <span class=o>=</span> <span class=o>*</span><span class=n>fb</span><span class=p>)</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_unlikely</span><span class=p>(</span><span class=nf>misaligned_chunk</span><span class=p>(</span><span class=n>tc_victim</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                        <span class=nf>malloc_printerr</span><span class=p>(</span><span class=s>&#34;malloc(): unaligned fastbin chunk detected 3&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=p>(</span><span class=n>SINGLE_THREAD_P</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=o>*</span><span class=n>fb</span> <span class=o>=</span> <span class=nf>REVEAL_PTR</span><span class=p>(</span><span class=n>tc_victim</span><span class=o>-&gt;</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=k>else</span>
</span></span><span class=line><span class=cl>                    <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=c1>// 斷鍊操作
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=nf>REMOVE_FB</span><span class=p>(</span><span class=n>fb</span><span class=p>,</span> <span class=n>pp</span><span class=p>,</span> <span class=n>tc_victim</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_unlikely</span><span class=p>(</span><span class=n>tc_victim</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                            <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=nf>tcache_put</span><span class=p>(</span><span class=n>tc_victim</span><span class=p>,</span> <span class=n>tc_idx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span></code></pre></div><h4 class="relative group">回傳記憶體<div id=%E5%9B%9E%E5%82%B3%E8%A8%98%E6%86%B6%E9%AB%94 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%9B%9E%E5%82%B3%E8%A8%98%E6%86%B6%E9%AB%94 aria-label=Anchor>#</a></span></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>            <span class=c1>// 返回mem地址
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kt>void</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=nf>chunk2mem</span><span class=p>(</span><span class=n>victim</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 加上0x10的header size
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nf>alloc_perturb</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>bytes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>  
</span></span></code></pre></div><h3 class="relative group">smallbin<div id=smallbin class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#smallbin aria-label=Anchor>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nf>in_smallbin_range</span><span class=p>(</span><span class=n>nb</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 計算對應大小的索引值
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>idx</span> <span class=o>=</span> <span class=nf>smallbin_index</span><span class=p>(</span><span class=n>nb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 獲取smallbin指標
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>bin</span> <span class=o>=</span> <span class=nf>bin_at</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>idx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=n>victim</span> <span class=o>=</span> <span class=nf>last</span><span class=p>(</span><span class=n>bin</span><span class=p>))</span> <span class=o>!=</span> <span class=n>bin</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>bck</span> <span class=o>=</span> <span class=n>victim</span><span class=o>-&gt;</span><span class=n>bk</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 檢查double linked list結構的完整性
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_unlikely</span><span class=p>(</span><span class=n>bck</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>!=</span> <span class=n>victim</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=nf>malloc_printerr</span><span class=p>(</span><span class=s>&#34;malloc(): smallbin double linked list corrupted&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 將chunk從尾端取出
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>set_inuse_bit_at_offset</span><span class=p>(</span><span class=n>victim</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>bin</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>=</span> <span class=n>bck</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>bck</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>=</span> <span class=n>bin</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 檢查是否為在main arena
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=n>av</span> <span class=o>!=</span> <span class=o>&amp;</span><span class=n>main_arena</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nf>set_non_main_arena</span><span class=p>(</span><span class=n>victim</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 檢查chunk是否正常
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>check_malloced_chunk</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>victim</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span>
</span></span></code></pre></div><h4 class="relative group">tcache<div id=tcache-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#tcache-1 aria-label=Anchor>#</a></span></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#if USE_TCACHE
</span></span></span><span class=line><span class=cl><span class=cp></span>        <span class=cm>/* While we&#39;re here, if we see other chunks of the same size,
</span></span></span><span class=line><span class=cl><span class=cm>            stash them in the tcache.  */</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 計算tcache index
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>size_t</span> <span class=n>tc_idx</span> <span class=o>=</span> <span class=nf>csize2tidx</span><span class=p>(</span><span class=n>nb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果tcache滿足要求
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=n>tcache</span> <span class=o>&amp;&amp;</span> <span class=n>tc_idx</span> <span class=o>&lt;</span> <span class=n>mp_</span><span class=p>.</span><span class=n>tcache_bins</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>mchunkptr</span> <span class=n>tc_victim</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=cm>/* While bin not empty and tcache not full, copy chunks over.  */</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 如果fastbin有東西然後tcache沒滿，把chunks裝到tcache
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>while</span> <span class=p>(</span><span class=n>tcache</span><span class=o>-&gt;</span><span class=n>counts</span><span class=p>[</span><span class=n>tc_idx</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>mp_</span><span class=p>.</span><span class=n>tcache_count</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>tc_victim</span> <span class=o>=</span> <span class=nf>last</span><span class=p>(</span><span class=n>bin</span><span class=p>))</span> <span class=o>!=</span> <span class=n>bin</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=n>tc_victim</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>bck</span> <span class=o>=</span> <span class=n>tc_victim</span><span class=o>-&gt;</span><span class=n>bk</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=nf>set_inuse_bit_at_offset</span><span class=p>(</span><span class=n>tc_victim</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=p>(</span><span class=n>av</span> <span class=o>!=</span> <span class=o>&amp;</span><span class=n>main_arena</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=nf>set_non_main_arena</span><span class=p>(</span><span class=n>tc_victim</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// 斷鏈操作，並把chunk放到tcache
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>bin</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>=</span> <span class=n>bck</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=n>bck</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>=</span> <span class=n>bin</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=nf>tcache_put</span><span class=p>(</span><span class=n>tc_victim</span><span class=p>,</span> <span class=n>tc_idx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span></code></pre></div><h4 class="relative group">回傳記憶體<div id=%E5%9B%9E%E5%82%B3%E8%A8%98%E6%86%B6%E9%AB%94-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%9B%9E%E5%82%B3%E8%A8%98%E6%86%B6%E9%AB%94-1 aria-label=Anchor>#</a></span></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>        <span class=c1>// 返回mem地址
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>void</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=nf>chunk2mem</span><span class=p>(</span><span class=n>victim</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 加上0x10的header size
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>alloc_perturb</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>bytes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 class="relative group">合併fastbin<div id=%E5%90%88%E4%BD%B5fastbin class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%90%88%E4%BD%B5fastbin aria-label=Anchor>#</a></span></h4><p>下面這段code的用意是為了在進行檢查儲存大chunk的bin(unsortedbin, largebin)之前先清除fastbin<br>因為fastbin不會主動合併，亦阻止了相鄰的chunk合併，使整個記憶體碎片化</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>idx</span> <span class=o>=</span> <span class=nf>largebin_index</span> <span class=p>(</span><span class=n>nb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>atomic_load_relaxed</span> <span class=p>(</span><span class=o>&amp;</span><span class=n>av</span><span class=o>-&gt;</span><span class=n>have_fastchunks</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nf>malloc_consolidate</span> <span class=p>(</span><span class=n>av</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 class="relative group">unsortedbin<div id=unsortedbin class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#unsortedbin aria-label=Anchor>#</a></span></h3><ul><li>拿到這個chunk和下個chunk的pointer</li><li>檢查chunk的結構有沒有被破壞</li></ul><h4 class="relative group">檢查<div id=%E6%AA%A2%E6%9F%A5 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E6%AA%A2%E6%9F%A5 aria-label=Anchor>#</a></span></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>for</span> <span class=p>(;;)</span> <span class=c1>//這個for迴圈同時包含了unsortedbin和largebin的實作，因為他們兩個息息相關
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>iters</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>((</span><span class=n>victim</span> <span class=o>=</span> <span class=nf>unsorted_chunks</span><span class=p>(</span><span class=n>av</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>bk</span><span class=p>)</span> <span class=o>!=</span> <span class=nf>unsorted_chunks</span><span class=p>(</span><span class=n>av</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>bck</span> <span class=o>=</span> <span class=n>victim</span><span class=o>-&gt;</span><span class=n>bk</span><span class=p>;</span> <span class=c1>// 取出 unsortedbin 倒數第二個 freed chunk (victim被為被取下來的那塊)
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>size</span> <span class=o>=</span> <span class=nf>chunksize</span><span class=p>(</span><span class=n>victim</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>mchunkptr</span> <span class=n>next</span> <span class=o>=</span> <span class=nf>chunk_at_offset</span><span class=p>(</span><span class=n>victim</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span> <span class=c1>// 根據chunksize找到下一個chunk的位置
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_unlikely</span><span class=p>(</span><span class=n>size</span> <span class=o>&lt;=</span> <span class=n>CHUNK_HDR_SZ</span><span class=p>)</span> <span class=o>||</span> <span class=nf>__glibc_unlikely</span><span class=p>(</span><span class=n>size</span> <span class=o>&gt;</span> <span class=n>av</span><span class=o>-&gt;</span><span class=n>system_mem</span><span class=p>))</span> <span class=c1>// chunk大小小於header大小或比heap空間大
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nf>malloc_printerr</span><span class=p>(</span><span class=s>&#34;malloc(): invalid size (unsorted)&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_unlikely</span><span class=p>(</span><span class=nf>chunksize_nomask</span><span class=p>(</span><span class=n>next</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>CHUNK_HDR_SZ</span><span class=p>)</span> <span class=o>||</span> <span class=nf>__glibc_unlikely</span><span class=p>(</span><span class=nf>chunksize_nomask</span><span class=p>(</span><span class=n>next</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>av</span><span class=o>-&gt;</span><span class=n>system_mem</span><span class=p>))</span> <span class=c1>// 檢查下一個chunk的大小是否正常
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nf>malloc_printerr</span><span class=p>(</span><span class=s>&#34;malloc(): invalid next size (unsorted)&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_unlikely</span><span class=p>((</span><span class=nf>prev_size</span><span class=p>(</span><span class=n>next</span><span class=p>)</span> <span class=o>&amp;</span> <span class=o>~</span><span class=p>(</span><span class=n>SIZE_BITS</span><span class=p>))</span> <span class=o>!=</span> <span class=n>size</span><span class=p>))</span> <span class=c1>// 檢查prev_size 是否等於當前 size
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nf>malloc_printerr</span><span class=p>(</span><span class=s>&#34;malloc(): mismatching next-&gt;prev_size (unsorted)&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_unlikely</span><span class=p>(</span><span class=n>bck</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>!=</span> <span class=n>victim</span><span class=p>)</span> <span class=o>||</span> <span class=nf>__glibc_unlikely</span><span class=p>(</span><span class=n>victim</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>!=</span> <span class=nf>unsorted_chunks</span><span class=p>(</span><span class=n>av</span><span class=p>)))</span> <span class=c1>// 檢查doubly linked list的完整性
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nf>malloc_printerr</span><span class=p>(</span><span class=s>&#34;malloc(): unsorted double linked list corrupted&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_unlikely</span><span class=p>(</span><span class=nf>prev_inuse</span><span class=p>(</span><span class=n>next</span><span class=p>)))</span> <span class=c1>// 檢查prev_inuse bit (unsortedbin 應該 unset prev_inuse bit)
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nf>malloc_printerr</span><span class=p>(</span><span class=s>&#34;malloc(): invalid next-&gt;prev_inuse (unsorted)&#34;</span><span class=p>);</span>
</span></span></code></pre></div><h4 class="relative group">使用last remainder<div id=%E4%BD%BF%E7%94%A8last-remainder class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E4%BD%BF%E7%94%A8last-remainder aria-label=Anchor>#</a></span></h4><p>滿足以下需求</p><ul><li>如果是small request(小於smallbin max request size，非largebin size)</li><li>且last remainder(切割剩下的chunk)是unsortedbin裡面唯一一塊chunk的話</li></ul><p>註: last remainder 一定會位於unsortedbin，因為切割過後的chunk會先放回unsortedbin</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>           If a small request, try to use last remainder if it is the
</span></span></span><span class=line><span class=cl><span class=cm>           only chunk in unsorted bin.  This helps promote locality for
</span></span></span><span class=line><span class=cl><span class=cm>           runs of consecutive small requests. This is the only
</span></span></span><span class=line><span class=cl><span class=cm>           exception to best-fit, and applies only when there is
</span></span></span><span class=line><span class=cl><span class=cm>           no exact fit for a small chunk.
</span></span></span><span class=line><span class=cl><span class=cm>        */</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nf>in_smallbin_range</span><span class=p>(</span><span class=n>nb</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>            <span class=n>bck</span> <span class=o>==</span> <span class=nf>unsorted_chunks</span><span class=p>(</span><span class=n>av</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>            <span class=n>victim</span> <span class=o>==</span> <span class=n>av</span><span class=o>-&gt;</span><span class=n>last_remainder</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>size</span><span class=p>)</span> <span class=o>&gt;</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>nb</span> <span class=o>+</span> <span class=n>MINSIZE</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=cm>/* split and reattach remainder */</span>
</span></span><span class=line><span class=cl>            <span class=n>remainder_size</span> <span class=o>=</span> <span class=n>size</span> <span class=o>-</span> <span class=n>nb</span><span class=p>;</span>                                    <span class=c1>// 計算remainder chunk被切下來的剩下大小
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>remainder</span> <span class=o>=</span> <span class=nf>chunk_at_offset</span><span class=p>(</span><span class=n>victim</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span>                       <span class=c1>// 偏移後得到新的remainder chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nf>unsorted_chunks</span><span class=p>(</span><span class=n>av</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>=</span> <span class=nf>unsorted_chunks</span><span class=p>(</span><span class=n>av</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>=</span> <span class=n>remainder</span><span class=p>;</span> <span class=c1>// 調整unsortedbin起始點(因為remainder已經被切割)
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>av</span><span class=o>-&gt;</span><span class=n>last_remainder</span> <span class=o>=</span> <span class=n>remainder</span><span class=p>;</span>                                <span class=c1>// 紀錄last remainder到main arena
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>remainder</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>=</span> <span class=n>remainder</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>=</span> <span class=nf>unsorted_chunks</span><span class=p>(</span><span class=n>av</span><span class=p>);</span>           <span class=c1>// 調整remainder的fd和bk
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>in_smallbin_range</span><span class=p>(</span><span class=n>remainder_size</span><span class=p>))</span>                        <span class=c1>// 如果remainder的size小於smallbin max request size的話
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>remainder</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span> <span class=c1>// 清空(fd_nextsize)，這邊有可能是因為從largebin切割完丟回來的
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>remainder</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=nf>set_head</span><span class=p>(</span><span class=n>victim</span><span class=p>,</span> <span class=n>nb</span> <span class=o>|</span> <span class=n>PREV_INUSE</span> <span class=o>|</span> <span class=p>(</span><span class=n>av</span> <span class=o>!=</span> <span class=o>&amp;</span><span class=n>main_arena</span> <span class=o>?</span> <span class=nl>NON_MAIN_ARENA</span> <span class=p>:</span> <span class=mi>0</span><span class=p>));</span> <span class=c1>//設定取下的chunk的 chunksize, prev_inuse bit, non_main_arena
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nf>set_head</span><span class=p>(</span><span class=n>remainder</span><span class=p>,</span> <span class=n>remainder_size</span> <span class=o>|</span> <span class=n>PREV_INUSE</span><span class=p>);</span> <span class=c1>// 設定remainder的prev_inuse bit 和isze
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nf>set_foot</span><span class=p>(</span><span class=n>remainder</span><span class=p>,</span> <span class=n>remainder_size</span><span class=p>);</span> <span class=c1>//設定remainder 下一個chunk的prev_size
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>            <span class=nf>check_malloced_chunk</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>victim</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=kt>void</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=nf>chunk2mem</span><span class=p>(</span><span class=n>victim</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nf>alloc_perturb</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>bytes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span></code></pre></div><h4 class="relative group">unlink<div id=unlink class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#unlink aria-label=Anchor>#</a></span></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>    <span class=cm>/* remove from unsorted list */</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_unlikely</span><span class=p>(</span><span class=n>bck</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>!=</span> <span class=n>victim</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=nf>malloc_printerr</span><span class=p>(</span><span class=s>&#34;malloc(): corrupted unsorted chunks 3&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>unsorted_chunks</span><span class=p>(</span><span class=n>av</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>=</span> <span class=n>bck</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>bck</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>=</span> <span class=nf>unsorted_chunks</span><span class=p>(</span><span class=n>av</span><span class=p>);</span>
</span></span></code></pre></div><h4 class="relative group">如果fit size<div id=%E5%A6%82%E6%9E%9Cfit-size class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%A6%82%E6%9E%9Cfit-size aria-label=Anchor>#</a></span></h4><ul><li>如果fit size的話就直接回傳那塊</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>        <span class=cm>/* Take now instead of binning if exact fit */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>size</span> <span class=o>==</span> <span class=n>nb</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>set_inuse_bit_at_offset</span><span class=p>(</span><span class=n>victim</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>av</span> <span class=o>!=</span> <span class=o>&amp;</span><span class=n>main_arena</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nf>set_non_main_arena</span><span class=p>(</span><span class=n>victim</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>#if USE_TCACHE
</span></span></span><span class=line><span class=cl><span class=cp></span>            <span class=cm>/* Fill cache first, return to user only if cache fills.
</span></span></span><span class=line><span class=cl><span class=cm>           We may return one of these chunks later.  */</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>tcache_nb</span> <span class=o>&amp;&amp;</span> <span class=n>tcache</span><span class=o>-&gt;</span><span class=n>counts</span><span class=p>[</span><span class=n>tc_idx</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>mp_</span><span class=p>.</span><span class=n>tcache_count</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nf>tcache_put</span><span class=p>(</span><span class=n>victim</span><span class=p>,</span> <span class=n>tc_idx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>return_cached</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>                <span class=nf>check_malloced_chunk</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>victim</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=kt>void</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=nf>chunk2mem</span><span class=p>(</span><span class=n>victim</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nf>alloc_perturb</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>bytes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#if USE_TCACHE
</span></span></span><span class=line><span class=cl><span class=cp></span>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>        <span class=p>}</span>
</span></span></code></pre></div><h4 class="relative group">放回smallbin的情況<div id=%E6%94%BE%E5%9B%9Esmallbin%E7%9A%84%E6%83%85%E6%B3%81 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E6%94%BE%E5%9B%9Esmallbin%E7%9A%84%E6%83%85%E6%B3%81 aria-label=Anchor>#</a></span></h4><p>(如果是smallbin range的話)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nf>in_smallbin_range</span><span class=p>(</span><span class=n>size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>victim_index</span> <span class=o>=</span> <span class=nf>smallbin_index</span><span class=p>(</span><span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>bck</span> <span class=o>=</span> <span class=nf>bin_at</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>victim_index</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>fwd</span> <span class=o>=</span> <span class=n>bck</span><span class=o>-&gt;</span><span class=n>fd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span></code></pre></div><h4 class="relative group">放回largebin的情況<div id=%E6%94%BE%E5%9B%9Elargebin%E7%9A%84%E6%83%85%E6%B3%81 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E6%94%BE%E5%9B%9Elargebin%E7%9A%84%E6%83%85%E6%B3%81 aria-label=Anchor>#</a></span></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>victim_index</span> <span class=o>=</span> <span class=nf>largebin_index</span><span class=p>(</span><span class=n>size</span><span class=p>);</span> <span class=c1>// 找到對應size的bin index
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>bck</span> <span class=o>=</span> <span class=nf>bin_at</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>victim_index</span><span class=p>);</span> <span class=c1>// 使用index找到bin的起始點
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>fwd</span> <span class=o>=</span> <span class=n>bck</span><span class=o>-&gt;</span><span class=n>fd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=cm>/* maintain large bins in sorted order */</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>fwd</span> <span class=o>!=</span> <span class=n>bck</span><span class=p>)</span> <span class=c1>// 如果bin鍊有東西
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=cm>/* Or with inuse bit to speed comparisons */</span>
</span></span><span class=line><span class=cl>                <span class=n>size</span> <span class=o>|=</span> <span class=n>PREV_INUSE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=cm>/* if smaller than smallest, bypass loop below */</span>
</span></span><span class=line><span class=cl>                <span class=nf>assert</span><span class=p>(</span><span class=nf>chunk_main_arena</span><span class=p>(</span><span class=n>bck</span><span class=o>-&gt;</span><span class=n>bk</span><span class=p>));</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>size</span><span class=p>)</span> <span class=o>&lt;</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)</span><span class=nf>chunksize_nomask</span><span class=p>(</span><span class=n>bck</span><span class=o>-&gt;</span><span class=n>bk</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// 如果size為比最後一塊(同時也是最小塊)還小，就直接插入尾端
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>fwd</span> <span class=o>=</span> <span class=n>bck</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=n>bck</span> <span class=o>=</span> <span class=n>bck</span><span class=o>-&gt;</span><span class=n>bk</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=n>victim</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span> <span class=o>=</span> <span class=n>fwd</span><span class=o>-&gt;</span><span class=n>fd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=n>victim</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span> <span class=o>=</span> <span class=n>fwd</span><span class=o>-&gt;</span><span class=n>fd</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=n>fwd</span><span class=o>-&gt;</span><span class=n>fd</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span> <span class=o>=</span> <span class=n>victim</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span> <span class=o>=</span> <span class=n>victim</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nf>assert</span><span class=p>(</span><span class=nf>chunk_main_arena</span><span class=p>(</span><span class=n>fwd</span><span class=p>));</span>
</span></span><span class=line><span class=cl>                    <span class=c1>//從鍊頭開始往下遍歷
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=k>while</span> <span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)</span><span class=n>size</span> <span class=o>&lt;</span> <span class=nf>chunksize_nomask</span><span class=p>(</span><span class=n>fwd</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                    <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=c1>// 找到跳過比他大的chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=n>fwd</span> <span class=o>=</span> <span class=n>fwd</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                        <span class=nf>assert</span><span class=p>(</span><span class=nf>chunk_main_arena</span><span class=p>(</span><span class=n>fwd</span><span class=p>));</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                        <span class=c1>// 檢查這個chunk的size是否跟他一致
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=k>if</span> <span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)</span><span class=n>size</span> <span class=o>==</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)</span><span class=nf>chunksize_nomask</span><span class=p>(</span><span class=n>fwd</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                        <span class=cm>/* Always insert in the second position.  */</span>
</span></span><span class=line><span class=cl>                        <span class=n>fwd</span> <span class=o>=</span> <span class=n>fwd</span><span class=o>-&gt;</span><span class=n>fd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=k>else</span>
</span></span><span class=line><span class=cl>                    <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=c1>// 如果沒有跟他一樣的話就新增一個size進入linked list
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=n>victim</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span> <span class=o>=</span> <span class=n>fwd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                        <span class=n>victim</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span> <span class=o>=</span> <span class=n>fwd</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_unlikely</span><span class=p>(</span><span class=n>fwd</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span> <span class=o>!=</span> <span class=n>fwd</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                            <span class=nf>malloc_printerr</span><span class=p>(</span><span class=s>&#34;malloc(): largebin double linked list corrupted (nextsize)&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                        <span class=n>fwd</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span> <span class=o>=</span> <span class=n>victim</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                        <span class=n>victim</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span> <span class=o>=</span> <span class=n>victim</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=n>bck</span> <span class=o>=</span> <span class=n>fwd</span><span class=o>-&gt;</span><span class=n>bk</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=p>(</span><span class=n>bck</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>!=</span> <span class=n>fwd</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=nf>malloc_printerr</span><span class=p>(</span><span class=s>&#34;malloc(): largebin double linked list corrupted (bk)&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span>
</span></span><span class=line><span class=cl>                <span class=n>victim</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span> <span class=o>=</span> <span class=n>victim</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span> <span class=o>=</span> <span class=n>victim</span><span class=p>;</span> <span class=c1>//如果largebin沒東西的話那就需要構造一下了
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span></code></pre></div><h4 class="relative group">放回bin中(剛剛那兩段只是為了找到bck和fwd)<div id=%E6%94%BE%E5%9B%9Ebin%E4%B8%AD%E5%89%9B%E5%89%9B%E9%82%A3%E5%85%A9%E6%AE%B5%E5%8F%AA%E6%98%AF%E7%82%BA%E4%BA%86%E6%89%BE%E5%88%B0bck%E5%92%8Cfwd class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E6%94%BE%E5%9B%9Ebin%E4%B8%AD%E5%89%9B%E5%89%9B%E9%82%A3%E5%85%A9%E6%AE%B5%E5%8F%AA%E6%98%AF%E7%82%BA%E4%BA%86%E6%89%BE%E5%88%B0bck%E5%92%8Cfwd aria-label=Anchor>#</a></span></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>        <span class=c1>// 放到對應bin中
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>mark_bin</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>victim_index</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>victim</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>=</span> <span class=n>bck</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>victim</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>=</span> <span class=n>fwd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>fwd</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>=</span> <span class=n>victim</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>bck</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>=</span> <span class=n>victim</span><span class=p>;</span>
</span></span></code></pre></div><h4 class="relative group">結束while迴圈<div id=%E7%B5%90%E6%9D%9Fwhile%E8%BF%B4%E5%9C%88 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E7%B5%90%E6%9D%9Fwhile%E8%BF%B4%E5%9C%88 aria-label=Anchor>#</a></span></h4><ul><li>如果unsorted放太多chunk到tcache的話就直接回傳(前提是大小有對應</li><li>但預設<code>mp_.tcache_unsorted_limit</code> = 0，所以也不會執行這段</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#if USE_TCACHE
</span></span></span><span class=line><span class=cl><span class=cp></span>        <span class=cm>/* If we&#39;ve processed as many chunks as we&#39;re allowed while
</span></span></span><span class=line><span class=cl><span class=cm>       filling the cache, return one of the cached ones.  */</span>
</span></span><span class=line><span class=cl>       <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>++</span><span class=n>tcache_unsorted_count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>return_cached</span> <span class=o>&amp;&amp;</span> <span class=n>mp_</span><span class=p>.</span><span class=n>tcache_unsorted_limit</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>tcache_unsorted_count</span> <span class=o>&gt;</span> <span class=n>mp_</span><span class=p>.</span><span class=n>tcache_unsorted_limit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nf>tcache_get</span><span class=p>(</span><span class=n>tc_idx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span></code></pre></div><ul><li>超過最大iteration限制就直接break</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define MAX_ITERS 10000
</span></span></span><span class=line><span class=cl><span class=cp></span>        <span class=k>if</span> <span class=p>(</span><span class=o>++</span><span class=n>iters</span> <span class=o>&gt;=</span> <span class=n>MAX_ITERS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></div><ul><li>unsortedbin binning code跑完之後，再檢查tcache一遍</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#if USE_TCACHE
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=cm>/* If all the small chunks we found ended up cached, return one now.  */</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>return_cached</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nf>tcache_get</span><span class=p>(</span><span class=n>tc_idx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></div><h3 class="relative group">largebin<div id=largebin class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#largebin aria-label=Anchor>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>       If a large request, scan through the chunks of current bin in
</span></span></span><span class=line><span class=cl><span class=cm>       sorted order to find smallest that fits.  Use the skip list for this.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>in_smallbin_range</span><span class=p>(</span><span class=n>nb</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>bin</span> <span class=o>=</span> <span class=nf>bin_at</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>idx</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>         <span class=cm>/* skip scan if empty or largest chunk is too small */</span>
</span></span><span class=line><span class=cl>         <span class=c1>// 遍歷特定大小，跳過那些比請求小或者是空的
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>((</span><span class=n>victim</span> <span class=o>=</span> <span class=nf>first</span><span class=p>(</span><span class=n>bin</span><span class=p>))</span> <span class=o>!=</span> <span class=n>bin</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)</span><span class=nf>chunksize_nomask</span><span class=p>(</span><span class=n>victim</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>nb</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>             <span class=n>victim</span> <span class=o>=</span> <span class=n>victim</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>             <span class=k>while</span> <span class=p>(((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>size</span> <span class=o>=</span> <span class=nf>chunksize</span><span class=p>(</span><span class=n>victim</span><span class=p>))</span> <span class=o>&lt;</span>
</span></span><span class=line><span class=cl>                     <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>nb</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                 <span class=n>victim</span> <span class=o>=</span> <span class=n>victim</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>             <span class=cm>/* Avoid removing the first entry for a size so that the skip
</span></span></span><span class=line><span class=cl><span class=cm>                list does not have to be rerouted.  */</span>
</span></span><span class=line><span class=cl>             <span class=c1>// 如果拿到的chunk不是該bin的最後一塊，我們選擇其前面那塊，這樣可以避免調整fd_nextsize和bk_nextsize
</span></span></span><span class=line><span class=cl><span class=c1></span>             <span class=c1>// 因為fd_nextsize和bk_nextsize都是指向某個大小的第一塊
</span></span></span><span class=line><span class=cl><span class=c1></span>             <span class=k>if</span> <span class=p>(</span><span class=n>victim</span> <span class=o>!=</span> <span class=nf>last</span><span class=p>(</span><span class=n>bin</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nf>chunksize_nomask</span><span class=p>(</span><span class=n>victim</span><span class=p>)</span> <span class=o>==</span> <span class=nf>chunksize_nomask</span><span class=p>(</span><span class=n>victim</span><span class=o>-&gt;</span><span class=n>fd</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                 <span class=n>victim</span> <span class=o>=</span> <span class=n>victim</span><span class=o>-&gt;</span><span class=n>fd</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>             <span class=n>remainder_size</span> <span class=o>=</span> <span class=n>size</span> <span class=o>-</span> <span class=n>nb</span><span class=p>;</span>
</span></span><span class=line><span class=cl>             <span class=nf>unlink_chunk</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>victim</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span></code></pre></div><h4 class="relative group">切割後的size不足成為一個chunk<div id=%E5%88%87%E5%89%B2%E5%BE%8C%E7%9A%84size%E4%B8%8D%E8%B6%B3%E6%88%90%E7%82%BA%E4%B8%80%E5%80%8Bchunk class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%88%87%E5%89%B2%E5%BE%8C%E7%9A%84size%E4%B8%8D%E8%B6%B3%E6%88%90%E7%82%BA%E4%B8%80%E5%80%8Bchunk aria-label=Anchor>#</a></span></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>             <span class=cm>/* Exhaust */</span>
</span></span><span class=line><span class=cl>             <span class=c1>// 切割後的size不能做為一個chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>             <span class=k>if</span> <span class=p>(</span><span class=n>remainder_size</span> <span class=o>&lt;</span> <span class=n>MINSIZE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>             <span class=p>{</span>
</span></span><span class=line><span class=cl>                 <span class=nf>set_inuse_bit_at_offset</span><span class=p>(</span><span class=n>victim</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                 <span class=k>if</span> <span class=p>(</span><span class=n>av</span> <span class=o>!=</span> <span class=o>&amp;</span><span class=n>main_arena</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                     <span class=nf>set_non_main_arena</span><span class=p>(</span><span class=n>victim</span><span class=p>);</span>
</span></span><span class=line><span class=cl>             <span class=p>}</span>
</span></span><span class=line><span class=cl>             
</span></span></code></pre></div><h4 class="relative group">切割chunk<div id=%E5%88%87%E5%89%B2chunk class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%88%87%E5%89%B2chunk aria-label=Anchor>#</a></span></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>            <span class=cm>/* Split */</span>
</span></span><span class=line><span class=cl>             <span class=k>else</span>
</span></span><span class=line><span class=cl>             <span class=p>{</span>
</span></span><span class=line><span class=cl>                 
</span></span><span class=line><span class=cl>                 <span class=n>remainder</span> <span class=o>=</span> <span class=nf>chunk_at_offset</span><span class=p>(</span><span class=n>victim</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                 <span class=cm>/* We cannot assume the unsorted list is empty and therefore
</span></span></span><span class=line><span class=cl><span class=cm>                    have to perform a complete insert here.  */</span>
</span></span><span class=line><span class=cl>                 <span class=n>bck</span> <span class=o>=</span> <span class=nf>unsorted_chunks</span><span class=p>(</span><span class=n>av</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                 <span class=n>fwd</span> <span class=o>=</span> <span class=n>bck</span><span class=o>-&gt;</span><span class=n>fd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                 <span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_unlikely</span><span class=p>(</span><span class=n>fwd</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>!=</span> <span class=n>bck</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                     <span class=nf>malloc_printerr</span><span class=p>(</span><span class=s>&#34;malloc(): corrupted unsorted chunks&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                 <span class=c1>// unlink操作
</span></span></span><span class=line><span class=cl><span class=c1></span>                 <span class=n>remainder</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>=</span> <span class=n>bck</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                 <span class=n>remainder</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>=</span> <span class=n>fwd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                 <span class=n>bck</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>=</span> <span class=n>remainder</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                 <span class=n>fwd</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>=</span> <span class=n>remainder</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                 <span class=c1>// 清空fd_nextsize &amp; bk_nextsize
</span></span></span><span class=line><span class=cl><span class=c1></span>                 <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>in_smallbin_range</span><span class=p>(</span><span class=n>remainder_size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                 <span class=p>{</span>
</span></span><span class=line><span class=cl>                     <span class=n>remainder</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                     <span class=n>remainder</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                 <span class=p>}</span>
</span></span><span class=line><span class=cl>                 
</span></span><span class=line><span class=cl>                 <span class=nf>set_head</span><span class=p>(</span><span class=n>victim</span><span class=p>,</span> <span class=n>nb</span> <span class=o>|</span> <span class=n>PREV_INUSE</span> <span class=o>|</span>
</span></span><span class=line><span class=cl>                                      <span class=p>(</span><span class=n>av</span> <span class=o>!=</span> <span class=o>&amp;</span><span class=n>main_arena</span> <span class=o>?</span> <span class=nl>NON_MAIN_ARENA</span> <span class=p>:</span> <span class=mi>0</span><span class=p>));</span> <span class=c1>//重新分配chunk的標記
</span></span></span><span class=line><span class=cl><span class=c1></span>                 <span class=nf>set_head</span><span class=p>(</span><span class=n>remainder</span><span class=p>,</span> <span class=n>remainder_size</span> <span class=o>|</span> <span class=n>PREV_INUSE</span><span class=p>);</span> <span class=c1>// 設置 remainder的prev_size
</span></span></span><span class=line><span class=cl><span class=c1></span>                 <span class=nf>set_foot</span><span class=p>(</span><span class=n>remainder</span><span class=p>,</span> <span class=n>remainder_size</span><span class=p>);</span> <span class=c1>// 設置 remainder下一個chunk的prev_size
</span></span></span><span class=line><span class=cl><span class=c1></span>             <span class=p>}</span>
</span></span></code></pre></div><h4 class="relative group">回傳記憶體<div id=%E5%9B%9E%E5%82%B3%E8%A8%98%E6%86%B6%E9%AB%94-2 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%9B%9E%E5%82%B3%E8%A8%98%E6%86%B6%E9%AB%94-2 aria-label=Anchor>#</a></span></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>             <span class=nf>check_malloced_chunk</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>victim</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>             <span class=c1>// 轉為mem型態
</span></span></span><span class=line><span class=cl><span class=c1></span>             <span class=kt>void</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=nf>chunk2mem</span><span class=p>(</span><span class=n>victim</span><span class=p>);</span>
</span></span><span class=line><span class=cl>             <span class=nf>alloc_perturb</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>bytes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>             <span class=k>return</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></div><h3 class="relative group">search for larger bin<div id=search-for-larger-bin class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#search-for-larger-bin aria-label=Anchor>#</a></span></h3><p>如果走到這邊，代表相同size的bin都不能滿足<br>會找更大的chunk</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>        <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>            Search for a chunk by scanning bins, starting with next largest
</span></span></span><span class=line><span class=cl><span class=cm>            bin. This search is strictly by best-fit; i.e., the smallest
</span></span></span><span class=line><span class=cl><span class=cm>            (with ties going to approximately the least recently used) chunk
</span></span></span><span class=line><span class=cl><span class=cm>            that fits is selected.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>            The bitmap avoids needing to check that most blocks are nonempty.
</span></span></span><span class=line><span class=cl><span class=cm>            The particular case of skipping all bins during warm-up phases
</span></span></span><span class=line><span class=cl><span class=cm>            when no chunks have been returned yet is faster than it might look.
</span></span></span><span class=line><span class=cl><span class=cm>        */</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果在這之前的方式都沒找到合適的bin的話
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 掃描所有bin
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// binmap: binmap會以bit為單位來紀錄bin鏈是否有東西
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 會有四組32 bit大小的整數，總共128 bit
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>++</span><span class=n>idx</span><span class=p>;</span> <span class=c1>// 下一個bin的索引值
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>bin</span> <span class=o>=</span> <span class=nf>bin_at</span> <span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>idx</span><span class=p>);</span> <span class=c1>// 下一個bin的指標位置
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>block</span> <span class=o>=</span> <span class=nf>idx2block</span> <span class=p>(</span><span class=n>idx</span><span class=p>);</span> <span class=c1>// 將idx轉成block，block一共四個，大小128，idx 0-31 為0，idx 32-63 為1，以此類推
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>map</span> <span class=o>=</span> <span class=n>av</span><span class=o>-&gt;</span><span class=n>binmap</span><span class=p>[</span><span class=n>block</span><span class=p>];</span> <span class=c1>// 獲取map
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>bit</span> <span class=o>=</span> <span class=nf>idx2bit</span> <span class=p>(</span><span class=n>idx</span><span class=p>);</span> <span class=c1>// 將idx轉回bit
</span></span></span></code></pre></div><h4 class="relative group">找到合適的bin<div id=%E6%89%BE%E5%88%B0%E5%90%88%E9%81%A9%E7%9A%84bin class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E6%89%BE%E5%88%B0%E5%90%88%E9%81%A9%E7%9A%84bin aria-label=Anchor>#</a></span></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(;;)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=cm>/* Skip rest of block if there are no more set bits in this block.  */</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 跳過空的bin鏈
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=p>(</span><span class=n>bit</span> <span class=o>&gt;</span> <span class=n>map</span> <span class=o>||</span> <span class=n>bit</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>do</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=p>(</span><span class=o>++</span><span class=n>block</span> <span class=o>&gt;=</span> <span class=n>BINMAPSIZE</span><span class=p>)</span> <span class=cm>/* out of bins */</span>
</span></span><span class=line><span class=cl>                        <span class=k>goto</span> <span class=n>use_top</span><span class=p>;</span> <span class=c1>// 如果所有block都被搜過了，然後沒東西就跳轉到use_top(使用top chunk分配)
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=p>}</span> <span class=k>while</span> <span class=p>((</span><span class=n>map</span> <span class=o>=</span> <span class=n>av</span><span class=o>-&gt;</span><span class=n>binmap</span><span class=p>[</span><span class=n>block</span><span class=p>])</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>bin</span> <span class=o>=</span> <span class=nf>bin_at</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=p>(</span><span class=n>block</span> <span class=o>&lt;&lt;</span> <span class=n>BINMAPSHIFT</span><span class=p>));</span>  
</span></span><span class=line><span class=cl>                <span class=n>bit</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=cm>/* Advance to bin with set bit. There must be one. */</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=p>((</span><span class=n>bit</span> <span class=o>&amp;</span> <span class=n>map</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=c1>// 找到block中有東西的bin鏈
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>bin</span> <span class=o>=</span> <span class=nf>next_bin</span><span class=p>(</span><span class=n>bin</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>bit</span> <span class=o>&lt;&lt;=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=nf>assert</span><span class=p>(</span><span class=n>bit</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=cm>/* Inspect the bin. It is likely to be non-empty */</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 獲取最後的chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>victim</span> <span class=o>=</span> <span class=nf>last</span><span class=p>(</span><span class=n>bin</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=cm>/*  If a false alarm (empty bin), clear the bit. */</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 如果bin-&gt;bk == bin的話代表bin鏈為空
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// 要清除bit，並繼續循環
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=p>(</span><span class=n>victim</span> <span class=o>==</span> <span class=n>bin</span><span class=p>)</span> <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>av</span><span class=o>-&gt;</span><span class=n>binmap</span><span class=p>[</span><span class=n>block</span><span class=p>]</span> <span class=o>=</span> <span class=n>map</span> <span class=o>&amp;=</span> <span class=o>~</span><span class=n>bit</span><span class=p>;</span> <span class=cm>/* Write through */</span>
</span></span><span class=line><span class=cl>                <span class=n>bin</span> <span class=o>=</span> <span class=nf>next_bin</span><span class=p>(</span><span class=n>bin</span><span class=p>);</span> 
</span></span><span class=line><span class=cl>                <span class=n>bit</span> <span class=o>&lt;&lt;=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span></code></pre></div><h4 class="relative group">找到<div id=%E6%89%BE%E5%88%B0 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E6%89%BE%E5%88%B0 aria-label=Anchor>#</a></span></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>size</span> <span class=o>=</span> <span class=nf>chunksize</span><span class=p>(</span><span class=n>victim</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cm>/*  We know the first chunk in this bin is big enough to use. */</span>
</span></span><span class=line><span class=cl>        <span class=nf>assert</span><span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>size</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>nb</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>remainder_size</span> <span class=o>=</span> <span class=n>size</span> <span class=o>-</span> <span class=n>nb</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cm>/* unlink */</span>
</span></span><span class=line><span class=cl>        <span class=nf>unlink_chunk</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>victim</span><span class=p>);</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>        <span class=cm>/* Exhaust */</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 切割剩下的size不足成為一個chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=n>remainder_size</span> <span class=o>&lt;</span> <span class=n>MINSIZE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>set_inuse_bit_at_offset</span><span class=p>(</span><span class=n>victim</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>av</span> <span class=o>!=</span> <span class=o>&amp;</span><span class=n>main_arena</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nf>set_non_main_arena</span><span class=p>(</span><span class=n>victim</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span></code></pre></div><h4 class="relative group">切割後的size不足成為一個chunk<div id=%E5%88%87%E5%89%B2%E5%BE%8C%E7%9A%84size%E4%B8%8D%E8%B6%B3%E6%88%90%E7%82%BA%E4%B8%80%E5%80%8Bchunk-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%88%87%E5%89%B2%E5%BE%8C%E7%9A%84size%E4%B8%8D%E8%B6%B3%E6%88%90%E7%82%BA%E4%B8%80%E5%80%8Bchunk-1 aria-label=Anchor>#</a></span></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>        <span class=cm>/* Split */</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 這邊都跟之前差不多
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>remainder</span> <span class=o>=</span> <span class=nf>chunk_at_offset</span><span class=p>(</span><span class=n>victim</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=cm>/* We cannot assume the unsorted list is empty and therefore
</span></span></span><span class=line><span class=cl><span class=cm>                have to perform a complete insert here.  */</span>
</span></span><span class=line><span class=cl>            <span class=n>bck</span> <span class=o>=</span> <span class=nf>unsorted_chunks</span><span class=p>(</span><span class=n>av</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>fwd</span> <span class=o>=</span> <span class=n>bck</span><span class=o>-&gt;</span><span class=n>fd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_unlikely</span><span class=p>(</span><span class=n>fwd</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>!=</span> <span class=n>bck</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=nf>malloc_printerr</span><span class=p>(</span><span class=s>&#34;malloc(): corrupted unsorted chunks 2&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>remainder</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>=</span> <span class=n>bck</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>remainder</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>=</span> <span class=n>fwd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>bck</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>=</span> <span class=n>remainder</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>fwd</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>=</span> <span class=n>remainder</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=cm>/* advertise as last remainder */</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nf>in_smallbin_range</span><span class=p>(</span><span class=n>nb</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=n>av</span><span class=o>-&gt;</span><span class=n>last_remainder</span> <span class=o>=</span> <span class=n>remainder</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>in_smallbin_range</span><span class=p>(</span><span class=n>remainder_size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>remainder</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>remainder</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=nf>set_head</span><span class=p>(</span><span class=n>victim</span><span class=p>,</span> <span class=n>nb</span> <span class=o>|</span> <span class=n>PREV_INUSE</span> <span class=o>|</span>
</span></span><span class=line><span class=cl>                                 <span class=p>(</span><span class=n>av</span> <span class=o>!=</span> <span class=o>&amp;</span><span class=n>main_arena</span> <span class=o>?</span> <span class=nl>NON_MAIN_ARENA</span> <span class=p>:</span> <span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=nf>set_head</span><span class=p>(</span><span class=n>remainder</span><span class=p>,</span> <span class=n>remainder_size</span> <span class=o>|</span> <span class=n>PREV_INUSE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nf>set_foot</span><span class=p>(</span><span class=n>remainder</span><span class=p>,</span> <span class=n>remainder_size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span></code></pre></div><h4 class="relative group">回傳記憶體<div id=%E5%9B%9E%E5%82%B3%E8%A8%98%E6%86%B6%E9%AB%94-3 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%9B%9E%E5%82%B3%E8%A8%98%E6%86%B6%E9%AB%94-3 aria-label=Anchor>#</a></span></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>        <span class=nf>check_malloced_chunk</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>victim</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>void</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=nf>chunk2mem</span><span class=p>(</span><span class=n>victim</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>alloc_perturb</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>bytes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 class="relative group">use top<div id=use-top class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#use-top aria-label=Anchor>#</a></span></h3><p>最後的情況會嘗試從 top chunk切割chunk下來</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=nl>use_top</span> <span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>       If large enough, split off the chunk bordering the end of memory
</span></span></span><span class=line><span class=cl><span class=cm>       (held in av-&gt;top). Note that this is in accord with the best-fit
</span></span></span><span class=line><span class=cl><span class=cm>       search rule.  In effect, av-&gt;top is treated as larger (and thus
</span></span></span><span class=line><span class=cl><span class=cm>       less well fitting) than any other available chunk since it can
</span></span></span><span class=line><span class=cl><span class=cm>       be extended to be as large as necessary (up to system
</span></span></span><span class=line><span class=cl><span class=cm>       limitations).
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>       We require that av-&gt;top always exists (i.e., has size &gt;=
</span></span></span><span class=line><span class=cl><span class=cm>       MINSIZE) after initialization, so if it would otherwise be
</span></span></span><span class=line><span class=cl><span class=cm>       exhausted by current request, it is replenished. (The main
</span></span></span><span class=line><span class=cl><span class=cm>       reason for ensuring it exists is that we may need MINSIZE space
</span></span></span><span class=line><span class=cl><span class=cm>       to put in fenceposts in sysmalloc.)
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>victim</span> <span class=o>=</span> <span class=n>av</span><span class=o>-&gt;</span><span class=n>top</span><span class=p>;</span> <span class=c1>// top_chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>size</span> <span class=o>=</span> <span class=nf>chunksize</span><span class=p>(</span><span class=n>victim</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_unlikely</span><span class=p>(</span><span class=n>size</span> <span class=o>&gt;</span> <span class=n>av</span><span class=o>-&gt;</span><span class=n>system_mem</span><span class=p>))</span> <span class=c1>// chunk size大於heap空間
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nf>malloc_printerr</span><span class=p>(</span><span class=s>&#34;malloc(): corrupted top size&#34;</span><span class=p>);</span>
</span></span></code></pre></div><h4 class="relative group">如果top chunk有足夠的大小可以被切割<div id=%E5%A6%82%E6%9E%9Ctop-chunk%E6%9C%89%E8%B6%B3%E5%A4%A0%E7%9A%84%E5%A4%A7%E5%B0%8F%E5%8F%AF%E4%BB%A5%E8%A2%AB%E5%88%87%E5%89%B2 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%A6%82%E6%9E%9Ctop-chunk%E6%9C%89%E8%B6%B3%E5%A4%A0%E7%9A%84%E5%A4%A7%E5%B0%8F%E5%8F%AF%E4%BB%A5%E8%A2%AB%E5%88%87%E5%89%B2 aria-label=Anchor>#</a></span></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>size</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>nb</span> <span class=o>+</span> <span class=n>MINSIZE</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>remainder_size</span> <span class=o>=</span> <span class=n>size</span> <span class=o>-</span> <span class=n>nb</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>remainder</span> <span class=o>=</span> <span class=nf>chunk_at_offset</span><span class=p>(</span><span class=n>victim</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>av</span><span class=o>-&gt;</span><span class=n>top</span> <span class=o>=</span> <span class=n>remainder</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=nf>set_head</span><span class=p>(</span><span class=n>victim</span><span class=p>,</span> <span class=n>nb</span> <span class=o>|</span> <span class=n>PREV_INUSE</span> <span class=o>|</span>
</span></span><span class=line><span class=cl>                                <span class=p>(</span><span class=n>av</span> <span class=o>!=</span> <span class=o>&amp;</span><span class=n>main_arena</span> <span class=o>?</span> <span class=nl>NON_MAIN_ARENA</span> <span class=p>:</span> <span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=nf>set_head</span><span class=p>(</span><span class=n>remainder</span><span class=p>,</span> <span class=n>remainder_size</span> <span class=o>|</span> <span class=n>PREV_INUSE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=nf>check_malloced_chunk</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>victim</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=kt>void</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=nf>chunk2mem</span><span class=p>(</span><span class=n>victim</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nf>alloc_perturb</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>bytes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span></code></pre></div><h4 class="relative group">如果沒有，檢查是否有fastbin<div id=%E5%A6%82%E6%9E%9C%E6%B2%92%E6%9C%89%E6%AA%A2%E6%9F%A5%E6%98%AF%E5%90%A6%E6%9C%89fastbin class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%A6%82%E6%9E%9C%E6%B2%92%E6%9C%89%E6%AA%A2%E6%9F%A5%E6%98%AF%E5%90%A6%E6%9C%89fastbin aria-label=Anchor>#</a></span></h4><p>fastbin不會自動合併，但<code>malloc_consolidate()</code>會把相鄰的fastbin合併</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>        <span class=k>else</span> <span class=nf>if</span> <span class=p>(</span><span class=nf>atomic_load_relaxed</span><span class=p>(</span><span class=o>&amp;</span><span class=n>av</span><span class=o>-&gt;</span><span class=n>have_fastchunks</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>malloc_consolidate</span><span class=p>(</span><span class=n>av</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=cm>/* restore original bin index */</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nf>in_smallbin_range</span><span class=p>(</span><span class=n>nb</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=n>idx</span> <span class=o>=</span> <span class=nf>smallbin_index</span><span class=p>(</span><span class=n>nb</span><span class=p>);</span> <span class=c1>//取出對映smallbin size的idx，會在下一個iteration被處理
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>else</span>
</span></span><span class=line><span class=cl>                <span class=n>idx</span> <span class=o>=</span> <span class=nf>largebin_index</span><span class=p>(</span><span class=n>nb</span><span class=p>);</span> <span class=c1>//取出對映largebin size的idx，會在下一個iteration被處理
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span></code></pre></div><h4 class="relative group">最終情況，會用sysmalloc再要一塊記憶體<div id=%E6%9C%80%E7%B5%82%E6%83%85%E6%B3%81%E6%9C%83%E7%94%A8sysmalloc%E5%86%8D%E8%A6%81%E4%B8%80%E5%A1%8A%E8%A8%98%E6%86%B6%E9%AB%94 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E6%9C%80%E7%B5%82%E6%83%85%E6%B3%81%E6%9C%83%E7%94%A8sysmalloc%E5%86%8D%E8%A6%81%E4%B8%80%E5%A1%8A%E8%A8%98%E6%86%B6%E9%AB%94 aria-label=Anchor>#</a></span></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>        <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>        Otherwise, relay to handle system-dependent cases
</span></span></span><span class=line><span class=cl><span class=cm>        */</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>void</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=nf>sysmalloc</span><span class=p>(</span><span class=n>nb</span><span class=p>,</span> <span class=n>av</span><span class=p>);</span> <span class=c1>//跟系統要一塊記憶體
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=p>(</span><span class=n>p</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nf>alloc_perturb</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>bytes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 class="relative group">__libc_realloc<div id=__libc_realloc class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#__libc_realloc aria-label=Anchor>#</a></span></h2><ul><li>擴展當前記憶體</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=nf>__libc_realloc</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>oldmem</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>bytes</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>mstate</span> <span class=n>ar_ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>INTERNAL_SIZE_T</span> <span class=n>nb</span><span class=p>;</span> <span class=cm>/* padded request size */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=o>*</span><span class=n>newp</span><span class=p>;</span> <span class=cm>/* chunk to return */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>__malloc_initialized</span><span class=p>)</span> <span class=c1>// 初始化(如果沒有)
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>ptmalloc_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#if REALLOC_ZERO_BYTES_FREES
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=k>if</span> <span class=p>(</span><span class=n>bytes</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>oldmem</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>__libc_free</span><span class=p>(</span><span class=n>oldmem</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>    <span class=cm>/* realloc of null is supposed to be same as malloc */</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>oldmem</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=c1>// 舊指標為空，可以使用malloc就好了
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=nf>__libc_malloc</span><span class=p>(</span><span class=n>bytes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* Perform a quick check to ensure that the pointer&#39;s tag matches the
</span></span></span><span class=line><span class=cl><span class=cm>       memory&#39;s tag.  */</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 確保pointer的tag和memory的tag相符
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_unlikely</span><span class=p>(</span><span class=n>mtag_enabled</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=o>*</span><span class=p>(</span><span class=k>volatile</span> <span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>oldmem</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* chunk corresponding to oldmem */</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>mchunkptr</span> <span class=n>oldp</span> <span class=o>=</span> <span class=nf>mem2chunk</span><span class=p>(</span><span class=n>oldmem</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=cm>/* its size */</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>INTERNAL_SIZE_T</span> <span class=n>oldsize</span> <span class=o>=</span> <span class=nf>chunksize</span><span class=p>(</span><span class=n>oldp</span><span class=p>);</span> <span class=c1>//取得舊的size
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>chunk_is_mmapped</span><span class=p>(</span><span class=n>oldp</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>ar_ptr</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>MAYBE_INIT_TCACHE</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>ar_ptr</span> <span class=o>=</span> <span class=nf>arena_for_chunk</span><span class=p>(</span><span class=n>oldp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* Little security check which won&#39;t hurt performance: the allocator
</span></span></span><span class=line><span class=cl><span class=cm>       never wrapps around at the end of the address space.  Therefore
</span></span></span><span class=line><span class=cl><span class=cm>       we can exclude some size values which might appear here by
</span></span></span><span class=line><span class=cl><span class=cm>       accident or by &#34;design&#34; from some intruder.  */</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=nf>__builtin_expect</span><span class=p>((</span><span class=kt>uintptr_t</span><span class=p>)</span><span class=n>oldp</span> <span class=o>&gt;</span> <span class=p>(</span><span class=kt>uintptr_t</span><span class=p>)</span><span class=o>-</span><span class=n>oldsize</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>||</span> <span class=nf>__builtin_expect</span><span class=p>(</span><span class=nf>misaligned_chunk</span><span class=p>(</span><span class=n>oldp</span><span class=p>),</span> <span class=mi>0</span><span class=p>)))</span> <span class=c1>// 確保舊指標沒越界
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>malloc_printerr</span><span class=p>(</span><span class=s>&#34;realloc(): invalid pointer&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>checked_request2size</span><span class=p>(</span><span class=n>bytes</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>nb</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>__set_errno</span><span class=p>(</span><span class=n>ENOMEM</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>chunk_is_mmapped</span><span class=p>(</span><span class=n>oldp</span><span class=p>))</span> <span class=c1>// chunk是否是mmap出來的
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>void</span> <span class=o>*</span><span class=n>newmem</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#if HAVE_MREMAP
</span></span></span><span class=line><span class=cl><span class=cp></span>        <span class=n>newp</span> <span class=o>=</span> <span class=nf>mremap_chunk</span><span class=p>(</span><span class=n>oldp</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span> <span class=c1>// 擴展記憶體或壓縮記憶體
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=n>newp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>void</span> <span class=o>*</span><span class=n>newmem</span> <span class=o>=</span> <span class=nf>chunk2mem_tag</span><span class=p>(</span><span class=n>newp</span><span class=p>);</span> 
</span></span><span class=line><span class=cl>            <span class=cm>/* Give the new block a different tag.  This helps to ensure
</span></span></span><span class=line><span class=cl><span class=cm>               that stale handles to the previous mapping are not
</span></span></span><span class=line><span class=cl><span class=cm>               reused.  There&#39;s a performance hit for both us and the
</span></span></span><span class=line><span class=cl><span class=cm>               caller for doing this, so we might want to
</span></span></span><span class=line><span class=cl><span class=cm>               reconsider.  */</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nf>tag_new_usable</span><span class=p>(</span><span class=n>newmem</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>        <span class=cm>/* Note the extra SIZE_SZ overhead. */</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>oldsize</span> <span class=o>-</span> <span class=n>SIZE_SZ</span> <span class=o>&gt;=</span> <span class=n>nb</span><span class=p>)</span> <span class=c1>// realloc的大小比原本的小
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>return</span> <span class=n>oldmem</span><span class=p>;</span> <span class=cm>/* do nothing */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cm>/* Must alloc, copy, free. */</span>
</span></span><span class=line><span class=cl>        <span class=n>newmem</span> <span class=o>=</span> <span class=nf>__libc_malloc</span><span class=p>(</span><span class=n>bytes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>newmem</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=mi>0</span><span class=p>;</span> <span class=cm>/* propagate failure */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nf>memcpy</span><span class=p>(</span><span class=n>newmem</span><span class=p>,</span> <span class=n>oldmem</span><span class=p>,</span> <span class=n>oldsize</span> <span class=o>-</span> <span class=n>CHUNK_HDR_SZ</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>munmap_chunk</span><span class=p>(</span><span class=n>oldp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>newmem</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>SINGLE_THREAD_P</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>newp</span> <span class=o>=</span> <span class=nf>_int_realloc</span><span class=p>(</span><span class=n>ar_ptr</span><span class=p>,</span> <span class=n>oldp</span><span class=p>,</span> <span class=n>oldsize</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>assert</span><span class=p>(</span><span class=o>!</span><span class=n>newp</span> <span class=o>||</span> <span class=nf>chunk_is_mmapped</span><span class=p>(</span><span class=nf>mem2chunk</span><span class=p>(</span><span class=n>newp</span><span class=p>))</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>               <span class=n>ar_ptr</span> <span class=o>==</span> <span class=nf>arena_for_chunk</span><span class=p>(</span><span class=nf>mem2chunk</span><span class=p>(</span><span class=n>newp</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>newp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>__libc_lock_lock</span><span class=p>(</span><span class=n>ar_ptr</span><span class=o>-&gt;</span><span class=n>mutex</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>newp</span> <span class=o>=</span> <span class=nf>_int_realloc</span><span class=p>(</span><span class=n>ar_ptr</span><span class=p>,</span> <span class=n>oldp</span><span class=p>,</span> <span class=n>oldsize</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>__libc_lock_unlock</span><span class=p>(</span><span class=n>ar_ptr</span><span class=o>-&gt;</span><span class=n>mutex</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>assert</span><span class=p>(</span><span class=o>!</span><span class=n>newp</span> <span class=o>||</span> <span class=nf>chunk_is_mmapped</span><span class=p>(</span><span class=nf>mem2chunk</span><span class=p>(</span><span class=n>newp</span><span class=p>))</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>           <span class=n>ar_ptr</span> <span class=o>==</span> <span class=nf>arena_for_chunk</span><span class=p>(</span><span class=nf>mem2chunk</span><span class=p>(</span><span class=n>newp</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>newp</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=c1>// 當記憶體分配失敗嘗試在其他arena分配
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=cm>/* Try harder to allocate memory in other arenas.  */</span>
</span></span><span class=line><span class=cl>        <span class=nf>LIBC_PROBE</span><span class=p>(</span><span class=n>memory_realloc_retry</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=n>bytes</span><span class=p>,</span> <span class=n>oldmem</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>newp</span> <span class=o>=</span> <span class=nf>__libc_malloc</span><span class=p>(</span><span class=n>bytes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>newp</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>size_t</span> <span class=n>sz</span> <span class=o>=</span> <span class=nf>memsize</span><span class=p>(</span><span class=n>oldp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nf>memcpy</span><span class=p>(</span><span class=n>newp</span><span class=p>,</span> <span class=n>oldmem</span><span class=p>,</span> <span class=n>sz</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>tag_region</span><span class=p>(</span><span class=nf>chunk2mem</span><span class=p>(</span><span class=n>oldp</span><span class=p>),</span> <span class=n>sz</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nf>_int_free</span><span class=p>(</span><span class=n>ar_ptr</span><span class=p>,</span> <span class=n>oldp</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>newp</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 class="relative group">_int_realloc()<div id=_int_realloc class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#_int_realloc aria-label=Anchor>#</a></span></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=nf>_int_realloc</span><span class=p>(</span><span class=n>mstate</span> <span class=n>av</span><span class=p>,</span> <span class=n>mchunkptr</span> <span class=n>oldp</span><span class=p>,</span> <span class=n>INTERNAL_SIZE_T</span> <span class=n>oldsize</span><span class=p>,</span>
</span></span><span class=line><span class=cl>             <span class=n>INTERNAL_SIZE_T</span> <span class=n>nb</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>mchunkptr</span> <span class=n>newp</span><span class=p>;</span>          <span class=cm>/* chunk to return */</span>
</span></span><span class=line><span class=cl>    <span class=n>INTERNAL_SIZE_T</span> <span class=n>newsize</span><span class=p>;</span> <span class=cm>/* its size */</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=o>*</span><span class=n>newmem</span><span class=p>;</span>            <span class=cm>/* corresponding user mem */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>mchunkptr</span> <span class=n>next</span><span class=p>;</span> <span class=cm>/* next contiguous chunk after oldp */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>mchunkptr</span> <span class=n>remainder</span><span class=p>;</span>          <span class=cm>/* extra space at end of newp */</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>remainder_size</span><span class=p>;</span> <span class=cm>/* its size */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* oldmem size */</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>__builtin_expect</span><span class=p>(</span><span class=nf>chunksize_nomask</span><span class=p>(</span><span class=n>oldp</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=n>CHUNK_HDR_SZ</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>||</span> <span class=nf>__builtin_expect</span><span class=p>(</span><span class=n>oldsize</span> <span class=o>&gt;=</span> <span class=n>av</span><span class=o>-&gt;</span><span class=n>system_mem</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=nf>malloc_printerr</span><span class=p>(</span><span class=s>&#34;realloc(): invalid old size&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>check_inuse_chunk</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>oldp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* All callers already filter out mmap&#39;ed chunks.  */</span>
</span></span><span class=line><span class=cl>    <span class=nf>assert</span><span class=p>(</span><span class=o>!</span><span class=nf>chunk_is_mmapped</span><span class=p>(</span><span class=n>oldp</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>next</span> <span class=o>=</span> <span class=nf>chunk_at_offset</span><span class=p>(</span><span class=n>oldp</span><span class=p>,</span> <span class=n>oldsize</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>INTERNAL_SIZE_T</span> <span class=n>nextsize</span> <span class=o>=</span> <span class=nf>chunksize</span><span class=p>(</span><span class=n>next</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>__builtin_expect</span><span class=p>(</span><span class=nf>chunksize_nomask</span><span class=p>(</span><span class=n>next</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=n>CHUNK_HDR_SZ</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>||</span> <span class=nf>__builtin_expect</span><span class=p>(</span><span class=n>nextsize</span> <span class=o>&gt;=</span> <span class=n>av</span><span class=o>-&gt;</span><span class=n>system_mem</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=nf>malloc_printerr</span><span class=p>(</span><span class=s>&#34;realloc(): invalid next size&#34;</span><span class=p>);</span>
</span></span></code></pre></div><h3 class="relative group">如果舊的夠大<div id=%E5%A6%82%E6%9E%9C%E8%88%8A%E7%9A%84%E5%A4%A0%E5%A4%A7 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%A6%82%E6%9E%9C%E8%88%8A%E7%9A%84%E5%A4%A0%E5%A4%A7 aria-label=Anchor>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>oldsize</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>nb</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=cm>/* already big enough; split below */</span>
</span></span><span class=line><span class=cl>        <span class=n>newp</span> <span class=o>=</span> <span class=n>oldp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>newsize</span> <span class=o>=</span> <span class=n>oldsize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></div><h3 class="relative group">嘗試向top chunk擴展<div id=%E5%98%97%E8%A9%A6%E5%90%91top-chunk%E6%93%B4%E5%B1%95 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%98%97%E8%A9%A6%E5%90%91top-chunk%E6%93%B4%E5%B1%95 aria-label=Anchor>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=cm>/* Try to expand forward into top */</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>next</span> <span class=o>==</span> <span class=n>av</span><span class=o>-&gt;</span><span class=n>top</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>newsize</span> <span class=o>=</span> <span class=n>oldsize</span> <span class=o>+</span> <span class=n>nextsize</span><span class=p>)</span> <span class=o>&gt;=</span>
</span></span><span class=line><span class=cl>                <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>nb</span> <span class=o>+</span> <span class=n>MINSIZE</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>set_head_size</span><span class=p>(</span><span class=n>oldp</span><span class=p>,</span> <span class=n>nb</span> <span class=o>|</span> <span class=p>(</span><span class=n>av</span> <span class=o>!=</span> <span class=o>&amp;</span><span class=n>main_arena</span> <span class=o>?</span> <span class=nl>NON_MAIN_ARENA</span> <span class=p>:</span> <span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=n>av</span><span class=o>-&gt;</span><span class=n>top</span> <span class=o>=</span> <span class=nf>chunk_at_offset</span><span class=p>(</span><span class=n>oldp</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nf>set_head</span><span class=p>(</span><span class=n>av</span><span class=o>-&gt;</span><span class=n>top</span><span class=p>,</span> <span class=p>(</span><span class=n>newsize</span> <span class=o>-</span> <span class=n>nb</span><span class=p>)</span> <span class=o>|</span> <span class=n>PREV_INUSE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nf>check_inuse_chunk</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>oldp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nf>tag_new_usable</span><span class=p>(</span><span class=nf>chunk2mem</span><span class=p>(</span><span class=n>oldp</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span></code></pre></div><h3 class="relative group">向下方free chunk擴展<div id=%E5%90%91%E4%B8%8B%E6%96%B9free-chunk%E6%93%B4%E5%B1%95 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%90%91%E4%B8%8B%E6%96%B9free-chunk%E6%93%B4%E5%B1%95 aria-label=Anchor>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>        <span class=c1>// 向下擴展，並切割
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>else</span> <span class=nf>if</span> <span class=p>(</span><span class=n>next</span> <span class=o>!=</span> <span class=n>av</span><span class=o>-&gt;</span><span class=n>top</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>                 <span class=o>!</span><span class=nf>inuse</span><span class=p>(</span><span class=n>next</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>                 <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>newsize</span> <span class=o>=</span> <span class=n>oldsize</span> <span class=o>+</span> <span class=n>nextsize</span><span class=p>)</span> <span class=o>&gt;=</span>
</span></span><span class=line><span class=cl>                     <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>nb</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>newp</span> <span class=o>=</span> <span class=n>oldp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=nf>unlink_chunk</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>next</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span></code></pre></div><h3 class="relative group">否則重新分配記憶體<div id=%E5%90%A6%E5%89%87%E9%87%8D%E6%96%B0%E5%88%86%E9%85%8D%E8%A8%98%E6%86%B6%E9%AB%94 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%90%A6%E5%89%87%E9%87%8D%E6%96%B0%E5%88%86%E9%85%8D%E8%A8%98%E6%86%B6%E9%AB%94 aria-label=Anchor>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>        <span class=cm>/* allocate, copy, free */</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 分配新記憶體，複製資料過去，然後釋放舊的記憶體
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>newmem</span> <span class=o>=</span> <span class=nf>_int_malloc</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>nb</span> <span class=o>-</span> <span class=n>MALLOC_ALIGN_MASK</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>newmem</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span><span class=p>;</span> <span class=cm>/* propagate failure */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>newp</span> <span class=o>=</span> <span class=nf>mem2chunk</span><span class=p>(</span><span class=n>newmem</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>newsize</span> <span class=o>=</span> <span class=nf>chunksize</span><span class=p>(</span><span class=n>newp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>               Avoid copy if newp is next chunk after oldp.
</span></span></span><span class=line><span class=cl><span class=cm>             */</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>newp</span> <span class=o>==</span> <span class=n>next</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>newsize</span> <span class=o>+=</span> <span class=n>oldsize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>newp</span> <span class=o>=</span> <span class=n>oldp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=kt>void</span> <span class=o>*</span><span class=n>oldmem</span> <span class=o>=</span> <span class=nf>chunk2mem</span><span class=p>(</span><span class=n>oldp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=kt>size_t</span> <span class=n>sz</span> <span class=o>=</span> <span class=nf>memsize</span><span class=p>(</span><span class=n>oldp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>tag_region</span><span class=p>(</span><span class=n>oldmem</span><span class=p>,</span> <span class=n>sz</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>newmem</span> <span class=o>=</span> <span class=nf>tag_new_usable</span><span class=p>(</span><span class=n>newmem</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nf>memcpy</span><span class=p>(</span><span class=n>newmem</span><span class=p>,</span> <span class=n>oldmem</span><span class=p>,</span> <span class=n>sz</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nf>_int_free</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>oldp</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nf>check_inuse_chunk</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>newp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>newmem</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span></code></pre></div><h2 class="relative group">__libc_calloc()<div id=__libc_calloc class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#__libc_calloc aria-label=Anchor>#</a></span></h2><ul><li>作用是會malloc一塊全部為0的記憶體</li><li>然後可以看到並不會從tcache取出chunk</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=o>*</span><span class=nf>__libc_calloc</span><span class=p>(</span><span class=kt>size_t</span> <span class=n>n</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>elem_size</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>mstate</span> <span class=n>av</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>mchunkptr</span> <span class=n>oldtop</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>INTERNAL_SIZE_T</span> <span class=n>sz</span><span class=p>,</span> <span class=n>oldtopsize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=o>*</span><span class=n>mem</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>clearsize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>nclears</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>INTERNAL_SIZE_T</span> <span class=o>*</span><span class=n>d</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>ptrdiff_t</span> <span class=n>bytes</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_unlikely</span><span class=p>(</span><span class=nf>__builtin_mul_overflow</span><span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=n>elem_size</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>bytes</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>__set_errno</span><span class=p>(</span><span class=n>ENOMEM</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>sz</span> <span class=o>=</span> <span class=n>bytes</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>__malloc_initialized</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>ptmalloc_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>MAYBE_INIT_TCACHE</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>//macro if (__glibc_unlikely (tcache == NULL)) \
</span></span></span><span class=line><span class=cl><span class=c1>    tcache_init();
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>SINGLE_THREAD_P</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>av</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>main_arena</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=nf>arena_get</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>sz</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>av</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=cm>/* Check if we hand out the top chunk, in which case there may be no
</span></span></span><span class=line><span class=cl><span class=cm>       need to clear. */</span>
</span></span><span class=line><span class=cl><span class=cp>#if MORECORE_CLEARS </span><span class=c1>// 不做清零
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>oldtop</span> <span class=o>=</span> <span class=nf>top</span><span class=p>(</span><span class=n>av</span><span class=p>);</span> <span class=c1>// 獲取topchunk
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>oldtopsize</span> <span class=o>=</span> <span class=nf>chunksize</span><span class=p>(</span><span class=nf>top</span><span class=p>(</span><span class=n>av</span><span class=p>));</span> <span class=c1>// 獲取topchunk size
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#if MORECORE_CLEARS &lt; 2
</span></span></span><span class=line><span class=cl><span class=cp></span>        <span class=cm>/* Only newly allocated memory is guaranteed to be cleared.  */</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 僅清除 top chunk 之外的部分記憶體
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=n>av</span> <span class=o>==</span> <span class=o>&amp;</span><span class=n>main_arena</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>            <span class=n>oldtopsize</span> <span class=o>&lt;</span> <span class=n>mp_</span><span class=p>.</span><span class=n>sbrk_base</span> <span class=o>+</span> <span class=n>av</span><span class=o>-&gt;</span><span class=n>max_system_mem</span> <span class=o>-</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>oldtop</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>oldtopsize</span> <span class=o>=</span> <span class=p>(</span><span class=n>mp_</span><span class=p>.</span><span class=n>sbrk_base</span> <span class=o>+</span> <span class=n>av</span><span class=o>-&gt;</span><span class=n>max_system_mem</span> <span class=o>-</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>oldtop</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>        <span class=k>if</span> <span class=p>(</span><span class=n>av</span> <span class=o>!=</span> <span class=o>&amp;</span><span class=n>main_arena</span><span class=p>)</span> <span class=c1>// 不在main arena
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>heap_info</span> <span class=o>*</span><span class=n>heap</span> <span class=o>=</span> <span class=nf>heap_for_ptr</span><span class=p>(</span><span class=n>oldtop</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>oldtopsize</span> <span class=o>&lt;</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>heap</span> <span class=o>+</span> <span class=n>heap</span><span class=o>-&gt;</span><span class=n>mprotect_size</span> <span class=o>-</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>oldtop</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>oldtopsize</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>heap</span> <span class=o>+</span> <span class=n>heap</span><span class=o>-&gt;</span><span class=n>mprotect_size</span> <span class=o>-</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>oldtop</span><span class=p>;</span> <span class=c1>// 確保沒有超過mprotect_size的區域
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=c1>// 沒有可用的arena
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=cm>/* No usable arenas.  */</span>
</span></span><span class=line><span class=cl>        <span class=n>oldtop</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>oldtopsize</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>mem</span> <span class=o>=</span> <span class=nf>_int_malloc</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>sz</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>assert</span><span class=p>(</span><span class=o>!</span><span class=n>mem</span> <span class=o>||</span> <span class=nf>chunk_is_mmapped</span><span class=p>(</span><span class=nf>mem2chunk</span><span class=p>(</span><span class=n>mem</span><span class=p>))</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>           <span class=n>av</span> <span class=o>==</span> <span class=nf>arena_for_chunk</span><span class=p>(</span><span class=nf>mem2chunk</span><span class=p>(</span><span class=n>mem</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>SINGLE_THREAD_P</span><span class=p>)</span> <span class=c1>// 多 thread 的情況
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>mem</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>av</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>LIBC_PROBE</span><span class=p>(</span><span class=n>memory_calloc_retry</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>sz</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>av</span> <span class=o>=</span> <span class=nf>arena_get_retry</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>sz</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>mem</span> <span class=o>=</span> <span class=nf>_int_malloc</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>sz</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>av</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nf>__libc_lock_unlock</span><span class=p>(</span><span class=n>av</span><span class=o>-&gt;</span><span class=n>mutex</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* Allocation failed even after a retry.  */</span>
</span></span><span class=line><span class=cl>    <span class=c1>// mem分配失敗
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>mem</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>mchunkptr</span> <span class=n>p</span> <span class=o>=</span> <span class=nf>mem2chunk</span><span class=p>(</span><span class=n>mem</span><span class=p>);</span> <span class=c1>//轉換mem成chunk結構
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=cm>/* If we are using memory tagging, then we need to set the tags
</span></span></span><span class=line><span class=cl><span class=cm>       regardless of MORECORE_CLEARS, so we zero the whole block while
</span></span></span><span class=line><span class=cl><span class=cm>       doing so.  */</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_unlikely</span><span class=p>(</span><span class=n>mtag_enabled</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nf>tag_new_zero_region</span><span class=p>(</span><span class=n>mem</span><span class=p>,</span> <span class=nf>memsize</span><span class=p>(</span><span class=n>p</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>INTERNAL_SIZE_T</span> <span class=n>csz</span> <span class=o>=</span> <span class=nf>chunksize</span><span class=p>(</span><span class=n>p</span><span class=p>);</span> <span class=c1>// chunk size
</span></span></span></code></pre></div><h3 class="relative group">清空mem<div id=%E6%B8%85%E7%A9%BAmem class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E6%B8%85%E7%A9%BAmem aria-label=Anchor>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>chunk_is_mmapped</span><span class=p>(</span><span class=n>p</span><span class=p>))</span> <span class=c1>//透過mmap分配的
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nf>__builtin_expect</span><span class=p>(</span><span class=n>perturb_byte</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nf>memset</span><span class=p>(</span><span class=n>mem</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>sz</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>mem</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#if MORECORE_CLEARS
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=k>if</span> <span class=p>(</span><span class=n>perturb_byte</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>p</span> <span class=o>==</span> <span class=n>oldtop</span> <span class=o>&amp;&amp;</span> <span class=n>csz</span> <span class=o>&gt;</span> <span class=n>oldtopsize</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=cm>/* clear only the bytes from non-freshly-sbrked memory */</span>
</span></span><span class=line><span class=cl>        <span class=n>csz</span> <span class=o>=</span> <span class=n>oldtopsize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>    <span class=cm>/* Unroll clear of &lt;= 36 bytes (72 if 8byte sizes).  We know that
</span></span></span><span class=line><span class=cl><span class=cm>       contents have an odd number of INTERNAL_SIZE_T-sized words;
</span></span></span><span class=line><span class=cl><span class=cm>       minimally 3.  */</span>
</span></span><span class=line><span class=cl>    <span class=n>d</span> <span class=o>=</span> <span class=p>(</span><span class=n>INTERNAL_SIZE_T</span> <span class=o>*</span><span class=p>)</span><span class=n>mem</span><span class=p>;</span> <span class=c1>// 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>clearsize</span> <span class=o>=</span> <span class=n>csz</span> <span class=o>-</span> <span class=n>SIZE_SZ</span><span class=p>;</span> <span class=c1>// 要清空的大小 (SIZE_SZ代表作業系統處理器的大小)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>nclears</span> <span class=o>=</span> <span class=n>clearsize</span> <span class=o>/</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>INTERNAL_SIZE_T</span><span class=p>);</span>  <span class=c1>// 要清空的大小
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>assert</span><span class=p>(</span><span class=n>nclears</span> <span class=o>&gt;=</span> <span class=mi>3</span><span class=p>);</span> <span class=c1>// 除了本身的大小之外，還有下一個chunk的prev_size
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>nclears</span> <span class=o>&gt;</span> <span class=mi>9</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nf>memset</span><span class=p>(</span><span class=n>d</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>clearsize</span><span class=p>);</span> <span class=c1>// 清空mem(迴圈方式)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=c1>// 清空mem
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>*</span><span class=p>(</span><span class=n>d</span> <span class=o>+</span> <span class=mi>0</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=o>*</span><span class=p>(</span><span class=n>d</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=o>*</span><span class=p>(</span><span class=n>d</span> <span class=o>+</span> <span class=mi>2</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>nclears</span> <span class=o>&gt;</span> <span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=o>*</span><span class=p>(</span><span class=n>d</span> <span class=o>+</span> <span class=mi>3</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=o>*</span><span class=p>(</span><span class=n>d</span> <span class=o>+</span> <span class=mi>4</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>nclears</span> <span class=o>&gt;</span> <span class=mi>6</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=o>*</span><span class=p>(</span><span class=n>d</span> <span class=o>+</span> <span class=mi>5</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=o>*</span><span class=p>(</span><span class=n>d</span> <span class=o>+</span> <span class=mi>6</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=n>nclears</span> <span class=o>&gt;</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=o>*</span><span class=p>(</span><span class=n>d</span> <span class=o>+</span> <span class=mi>7</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=o>*</span><span class=p>(</span><span class=n>d</span> <span class=o>+</span> <span class=mi>8</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>mem</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 class="relative group">References<div id=references class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#references aria-label=Anchor>#</a></span></h2><ul><li><a href=https://elixir.bootlin.com/glibc/glibc-2.35/source/malloc/ target=_blank>https://elixir.bootlin.com/glibc/glibc-2.35/source/malloc/</a></li><li><a href="https://www.kn0sky.com/?p=11a87cc5-03f1-4b05-b5ea-c6cda6cce999" target=_blank>https://www.kn0sky.com/?p=11a87cc5-03f1-4b05-b5ea-c6cda6cce999</a></li><li><a href=https://blog.csdn.net/Tokameine/article/details/119482061 target=_blank>https://blog.csdn.net/Tokameine/article/details/119482061</a></li><li><a href=https://lowerbyte.github.io/Inside-malloc-part-1-malloc/ target=_blank>https://lowerbyte.github.io/Inside-malloc-part-1-malloc/</a></li><li><a href=https://github.com/HATTER-LONG/glibc_Learnging/blob/main/Doc/02 target=_blank>https://github.com/HATTER-LONG/glibc_Learnging/blob/main/Doc/02</a>_内存管理/05_Ptmalloc内存申请分析_下.md</li><li><a href=https://blog.csdn.net/initphp/article/details/132815489 target=_blank>https://blog.csdn.net/initphp/article/details/132815489</a></li></ul></div><details style=margin-left:0 class="mt-2 mb-5 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5"><summary class="py-1 text-lg font-semibold cursor-pointer bg-primary-200 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-primary-800 dark:text-neutral-100">Heap Exploitation - This article is part of a series.</summary><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=https://asia-hokak.github.io/notes/pwn/heap/1-heap/>Part 1: Heap</a></div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=https://asia-hokak.github.io/notes/pwn/heap/2-chunk/>Part 2: Chunk</a></div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=https://asia-hokak.github.io/notes/pwn/heap/3-bin/>Part 3: Bin</a></div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=https://asia-hokak.github.io/notes/pwn/heap/4-arena/>Part 4: Arena</a></div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">Part 5: This Article</div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=https://asia-hokak.github.io/notes/pwn/heap/6-free/>Part 6: Free</a></div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=https://asia-hokak.github.io/notes/pwn/heap/9-fastbin-attack/>Part 9: Fastbin Attack</a></div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=https://asia-hokak.github.io/notes/pwn/heap/10-tcache-poision/>Part 10: Tcache Poision</a></div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=https://asia-hokak.github.io/notes/pwn/heap/11-unsorted-bin-attack/>Part 11: Unsorted Bin Attack</a></div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=https://asia-hokak.github.io/notes/pwn/heap/12-largebin_attack/>Part 12: Largebin Attack</a></div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=https://asia-hokak.github.io/notes/pwn/heap/13-unsafe-unlink/>Part 13: Unsafe Unlink</a></div></details></div><script>var oid="views_notes/pwn/heap/5-malloc/index.md",oid_likes="likes_notes/pwn/heap/5-malloc/index.md"</script><script type=text/javascript src=/js/page.min.0860cf4e04fa2d72cc33ddba263083464d48f67de06114529043cb4623319efed4f484fd7f1730df5abea0e2da6f3538855634081d02f2d6e920b956f063e823.js integrity="sha512-CGDPTgT6LXLMM926JjCDRk1I9n3gYRRSkEPLRiMxnv7U9IT9fxcw31q+oOLabzU4hVY0CB0C8tbpILlW8GPoIw=="></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=/notes/pwn/heap/13-unsafe-unlink/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Unsafe Unlink</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2024-12-24 00:00:00 +0000 UTC">2024-12-24</time>
</span></span></a></span><span><a class="flex text-right group ml-3" href=/notes/pwn/heap/6-free/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Free</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2025-02-23 00:00:00 +0000 UTC">2025-02-23</time>
</span></span><span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2025
hokak</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a></p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=https://asia-hokak.github.io/ style=z-index:500><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>